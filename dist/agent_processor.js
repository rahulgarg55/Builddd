var cfg=require("../../pbx_config.js"),fs=require("fs"),pbx_logger=require("./logger/pbx_logger.js"),request=require("request"),pbx_api=require("./api/pbx_api.js"),pbx_db=require("./pbx_db.js"),dt=require("./common/datetime.js"),cdr=require("./cdr.js"),logger=new pbx_logger,api=new pbx_api,sqlConn=new pbx_db,dateTime=new dt;function agent_processor(){if(!(this instanceof agent_processor))return new agent_processor}(module.exports=agent_processor).prototype.freeAgent=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [freeAgent]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","AgentID("+o.idealAgentID+") AgentGroup("+o.idealAgentGroup+") AgentNumber("+o.idealAgentNumber+") marking free!"),logger.log("DEB",o.channel.id,"agent_processor","inside function makeAgentFree");logger.log("DEB",o.channel.id,"agent_processor","Calling function setAgentFree with Param AgentID("+o.idealAgentID+"), catDesc("+o.catDescAgent+"), agentrepeatid(0), flag(2), alogtype("+o.smeAlgorithm+")"),api.setAgentFree(o.channel.id,o.idealAgentID,o.catDescAgent,"0","2",o.smeAlgorithm,o.callSessionId,function(e,l,n){e||200!=l.statusCode?(logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call:"+e),logger.log("AGENTCDR",o.channel.id,"agent_processor","!(http fail) Fail to free Agent - Number("+o.idealAgentNumber+")  AgentID("+o.idealAgentID+") SMEID("+o.smeID+") SessionId("+o.callSessionId+")")):(logger.log("DEB",o.channel.id,"agent_processor","*********************************"+n),logger.log("DEB",o.channel.id,"agent_processor","freeAgent HTML Received: "+n),n&&n.status&&1==n.status?n.data&&n.data[0].status?"1"==n.data[0].status?(logger.log("DEB",o.channel.id,"agent_processor","Successfully able to free the agent name("+n.data[0].agent_name+") number("+n.data[0].agent_mobile+")"),logger.log("AGENTCDR",o.channel.id,"agent_processor","Sucessfully free Agent - Name("+n.data[0].agent_name+") Number("+n.data[0].agent_mobile+") Email("+n.data[0].agent_email+") SMEID("+n.data[0].sme_id+") Status("+n.data[0].status+")  SessionId("+o.callSessionId+")")):(logger.log("ERR",o.channel.id,"agent_processor","failed to free the agent name("+n.data[0].agent_name+") number("+n.data[0].agent_mobile+")"),logger.log("AGENTCDR",o.channel.id,"agent_processor","!Fail to free Agent - Name("+n.data[0].agent_name+") Number("+n.data[0].agent_mobile+") Email("+n.data[0].agent_email+") SMEID("+n.data[0].sme_id+") Status("+n.data[0].status+")  SessionId("+o.callSessionId+")")):(logger.log("ERR",o.channel.id,"agent_processor","2 invalid details.."),console.log(n),logger.log("AGENTCDR",o.channel.id,"agent_processor","!(invalid data) Fail to free Agent - Number("+o.idealAgentNumber+")  AgentID("+o.idealAgentID+") SMEID("+o.smeID+") SessionId("+o.callSessionId+")")):(logger.log("ERR",o.channel.id,"agent_processor","invalid details.."),console.log(n),logger.log("AGENTCDR",o.channel.id,"agent_processor","!(invalid data-2) Fail to free Agent - Number("+o.idealAgentNumber+")  AgentID("+o.idealAgentID+") SMEID("+o.smeID+") SessionId("+o.callSessionId+")")))})},agent_processor.prototype.freeAgentPR=function(o,e,l,n){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [freeAgentPR - Parallel Ringing]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","AgentID("+e+") AgentGroup("+n+") AgentNumber("+l+") marking free!"),logger.log("DEB",o.channel.id,"agent_processor","inside function makeAgentFree");logger.log("DEB",o.channel.id,"agent_processor","Calling function setAgentFree with Param AgentID("+o.idealAgentID+"), catDesc("+o.catDescAgent+"), agentrepeatid(0), flag(2), alogtype("+o.smeAlgorithm+")"),api.setAgentFree(o.channel.id,e,n,"0","2","0",o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call:"+e):(logger.log("DEB",o.channel.id,"agent_processor","HTML Received: "+n),logger.log("DEB",o.channel.id,"agent_processor","*********************************"+n),logger.log("DEB",o.channel.id,"agent_processor","freeAgent HTML Received: "+n),n&&n.status&&1==n.status?n.data&&n.data[0].status?"1"==n.data[0].status?(logger.log("DEB",o.channel.id,"agent_processor","Successfully able to free the agent name("+n.data[0].agent_name+") number("+n.data[0].agent_mobile+")"),logger.log("AGENTCDR",o.channel.id,"agent_processor","Sucessfully free Agent - Name("+n.data[0].agent_name+") Number("+n.data[0].agent_mobile+") Email("+n.data[0].agent_email+") SMEID("+n.data[0].sme_id+") Status("+n.data[0].status+")")):(logger.log("ERR",o.channel.id,"agent_processor","failed to free the agent name("+n.data[0].agent_name+") number("+n.data[0].agent_mobile+")"),logger.log("AGENTCDR",o.channel.id,"agent_processor","!Fail to free Agent - Name("+n.data[0].agent_name+") Number("+n.data[0].agent_mobile+") Email("+n.data[0].agent_email+") SMEID("+n.data[0].sme_id+") Status("+n.data[0].status+")")):(logger.log("ERR",o.channel.id,"agent_processor","2 invalid details.."),console.log(n)):(logger.log("ERR",o.channel.id,"agent_processor","invalid details.."),console.log(n)))})},agent_processor.prototype.freeTransferAgent=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [freeTransferAgent]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","AgentID("+o.transAgentId+") AgentGroup("+o.transAgentGroup+") AgentNumber("+o.transAgentMobile+") marking free!"),logger.log("DEB",o.channel.id,"agent_processor","inside function makeAgentFree");logger.log("DEB",o.channel.id,"agent_processor","Calling function setAgentFree with Param AgentID("+o.transAgentId+"), catDesc("+o.transAgentGroup+"), agentrepeatid(0), flag(2), alogtype("+o.smeAlgorithm+")"),api.setAgentFree(o.channel.id,o.transAgentId,o.transAgentGroup,"0","2",o.smeAlgorithm,o.callSessionId,function(e,l,n){!e&&200==l.statusCode||logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call:"+e)})},agent_processor.prototype.setEndCallCdr=function(o,e){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [setEndCallCdr]"),logger.log("DEB",o.channel.id,"agent_processor",""),o.callendDateTime=dateTime.getcallDateTime(),o.callendDateTimeV2=dateTime.getcallDateTime(),o.callDuration=dateTime.calculateDuration(o.callstartDateTime,o.callendDateTime),o.callinsertDateTime=dateTime.getcallDateTime(),o.queue_name=o.gflowQueueName,o.queue_id=o.gflowQueueId;function l(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call:"+e):logger.log("DEB",o.channel.id,"agent_processor","HTML Received: "+n)}function n(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","postCdrResponseHandler2 Error thrown at url call:"+e):logger.log("DEB",o.channel.id,"agent_processor","postCdrResponseHandler2 HTML Received: "+n)}"none"==o.callpatchedAgentGroup&&(o.callpatchedAgentGroup="0"),logger.log("DEB",o.channel.id,"agent_processor","endCallCdrProcessedFlag("+o.endCallCdrProcessedFlag+"), callDirection("+o.callDirection+")"),1==o.endCallCdrProcessedFlag&&"INCOMING"==o.callDirection?(o.endCallProvisionalFlag="0",logger.log("DEB",o.channel.id,"agent_processor","setting endCallProvisionalFlag to 0")):0==o.endCallCdrProcessedFlag&&"INCOMING"==o.callDirection?(logger.log("DEB",o.channel.id,"agent_processor","setting endCallProvisionalFlag to 1 & endCallCdrProcessedFlag true"),o.endCallProvisionalFlag="1",o.endCallCdrProcessedFlag=!0):(o.endCallProvisionalFlag="0",logger.log("DEB",o.channel.id,"agent_processor","setting endCallProvisionalFlag to 0 - else case")),logger.log("DEB",o.channel.id,"agent_processor","callpatchedAgentId("+o.callpatchedAgentId+"), triedAgentList length("+o.triedAgentList.length+"), idealAgentID("+o.idealAgentID+")"),"none"==o.callpatchedAgentId?(o.callpatchedAgentId="2",logger.log("DEB",o.channel.id,"agent_processor","case:1 setting callpatchedAgentId = 2")):"1"==o.triedAgentList.length?(console.log("((((((((((((((((((((((((((((((((((((((((((((((((((((((("),console.log(o.triedAgentListV2),console.log(")))))))))))))))))))))))))))))))))))))))))))))))))))))))"),o.callpatchedAgentId="1",o.callpatchedAgentId=o.triedAgentList[0].agentId,logger.log("DEB",o.channel.id,"agent_processor","case:2 setting callpatchedAgentId = "+o.callpatchedAgentId)):"1"<o.triedAgentList.length&&"INCOMING"==o.callDirection&&"2"==o.callanswerFlag&&(console.log("((((((((((((((((((((((((((((((((((((((((((((((((((((((("),console.log(o.triedAgentListV2),console.log(")))))))))))))))))))))))))))))))))))))))))))))))))))))))"),a=o.triedAgentListV2.filter((e,l,n)=>n.indexOf(e)===l),console.log(a),"1"<a.length?(console.log("now it is more than one agent so adding id as (1) because count is "+a.length),o.callpatchedAgentId="1"):(console.log("now it is one agent so adding id as ("+a[0]+")"),o.callpatchedAgentId=a[0]),console.log(")))))))))))))))))))))))))))))))))))))))))))))))))))))))"),logger.log("DEB",o.channel.id,"agent_processor","case:3 setting callpatchedAgentId = 1")),"0"!=o.voicemailRecordingFile&&"1"==o.voicemailRecordingStatus&&(o.callDirection="INCOMING",o.callcdrMode="3"),"OUTGOING"!=o.callDirection&&(o.called_number=o.channel.dialplan.exten),"10"<=o.idealAgentNumber.length&&"INCOMING"==o.callDirection&&"1"==o.callanswerFlag&&(o.called_number=o.idealAgentNumber),logger.log("DEB",o.channel.id,"agent_processor","CustomerConnectedDuration("+o.CustomerConnectedDuration+")"),"INCOMING"==o.callDirection&&"1"==o.callanswerFlag?o.AgentConnectedDuration<="0"||isNaN(o.AgentConnectedDuration)?logger.log("DEB",o.channel.id,"agent_processor","Dont copy AgentConnectedDuration("+o.AgentConnectedDuration+") to CustomerConnectedDuration("+o.CustomerConnectedDuration+")"):(o.CustomerConnectedDuration=o.AgentConnectedDuration,logger.log("DEB",o.channel.id,"agent_processor","lets copy AgentConnectedDuration("+o.AgentConnectedDuration+") to CustomerConnectedDuration("+o.CustomerConnectedDuration+")")):"INCOMING"==o.callDirection&&"2"==o.callanswerFlag&&(o.CustomerConnectedDuration="0"),"agent_disconnect"==o.calldisconnectedBy?o.calldisconnectedBy="agent":"user_disconnect"!=o.calldisconnectedBy&&"customer_disconnect"!=o.calldisconnectedBy||(o.calldisconnectedBy="customer");var a="";logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),a="OUTGOING"==o.callDirection&&"22"==o.callcdrMode&&(logger.log("DEB",o.channel.id,"agent_processor","================================oppppppssssdddd============================== callDirection("+o.callDirection+")  callcdrMode("+o.callcdrMode+")   ===> customer_number("+o.customer_number+")"),""!=o.customer_number)&&"0"!=o.customer_number?o.customer_number:o.channel.caller.number,"99"==o.finalDTMF&&(logger.log("DEB",o.channel.id,"agent_processor","finalDTMF("+o.finalDTMF+") so Changed to 0"),o.finalDTMF="0"),logger.log("DEB",o.channel.id,"agent_processor","checking -- idealAgentGroup("+o.idealAgentGroup+") & callpatchedAgentGroup("+o.callpatchedAgentGroup+")"),"0"!=o.callpatchedAgentGroup&&""!=o.callpatchedAgentGroup&&null!=o.callpatchedAgentGroup||"0"==o.idealAgentGroup||(o.callpatchedAgentGroup=o.idealAgentGroup),"0"!=o.callpatchedAgentGroup&&""!=o.callpatchedAgentGroup&&null!=o.callpatchedAgentGroup||"0"==o.assigned_agent_group||(o.callpatchedAgentGroup=o.assigned_agent_group),"0"==o.callpatchedAgentGroup&&(o.callpatchedAgentGroup="na"),o.gflowName=o.ivrCallFlowName,o.finalDTMF=o.allIvrDtmf,logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),logger.log("DEB",o.channel.id,"agent_processor","duration("+o.callDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentRingingDuration("+o.AgentRingingDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentConnectedDuration("+o.AgentConnectedDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","CustomerRingingDuration("+o.CustomerRingingDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","CustomerConnectedDuration("+o.CustomerConnectedDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","=============================================================="),logger.log("DEB",o.channel.id,"agent_processor","addressBookName("+o.address_book_name+")"),logger.log("DEB",o.channel.id,"agent_processor","addressBookId("+o.address_book_id+")"),logger.log("DEB",o.channel.id,"agent_processor","agentGroup("+o.callpatchedAgentGroup+")"),logger.log("DEB",o.channel.id,"agent_processor","callDirection("+o.callDirection+")"),logger.log("DEB",o.channel.id,"agent_processor","callDirectionStatus("+o.callDirectionStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordedFileRaw("+o.callRecordedFileRaw+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordingStatus("+o.callRecordingStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","calledNumber("+o.called_number+")"),logger.log("DEB",o.channel.id,"agent_processor","callingNumber("+a+")"),logger.log("DEB",o.channel.id,"agent_processor","cdrMode("+o.callcdrMode+")"),logger.log("DEB",o.channel.id,"agent_processor","channelNo("+o.callchannelNo+")"),logger.log("DEB",o.channel.id,"agent_processor","duration("+o.callDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","endDateTime("+o.callendDateTimeV2+")"),logger.log("DEB",o.channel.id,"agent_processor","startDateTime("+o.callstartDateTimeV2+")"),logger.log("DEB",o.channel.id,"agent_processor","hlr("+o.callHlr+")"),logger.log("DEB",o.channel.id,"agent_processor","insertDateTime("+o.callinsertDateTime+")"),logger.log("DEB",o.channel.id,"agent_processor","longcode("+o.calllongcode+")"),logger.log("DEB",o.channel.id,"agent_processor","masterShortcode("+o.callmasterShortcode+")"),logger.log("DEB",o.channel.id,"agent_processor","patchedAgentId("+o.callpatchedAgentId+")"),logger.log("DEB",o.channel.id,"agent_processor","serverIpAddress("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","shortcodeMapping("+o.callshortcodeMapping+")"),logger.log("DEB",o.channel.id,"agent_processor","smeId("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","smeIdentifier("+o.callsmeIdentifier+")"),logger.log("DEB",o.channel.id,"agent_processor","voicemailRecordingFile("+o.voicemailRecordingFile+")"),logger.log("DEB",o.channel.id,"agent_processor","voicemailRecordingStatus("+o.voicemailRecordingStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","groupid("+o.callgroupid+")"),logger.log("DEB",o.channel.id,"agent_processor","callid("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","cdrFlag("+o.callcdrFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","answerFlag("+o.callanswerFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","callStatus("+o.callfinalStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","disconnectedBy("+o.calldisconnectedBy+")"),logger.log("DEB",o.channel.id,"agent_processor","addressBookId("+o.addressBookId+")"),logger.log("DEB",o.channel.id,"agent_processor","callType("+o.callType+")"),logger.log("DEB",o.channel.id,"agent_processor","callModeNew("+o.callModeNew+")"),logger.log("DEB",o.channel.id,"agent_processor","endCallDescription("+o.endCallDescription+")"),logger.log("DEB",o.channel.id,"agent_processor","IvrCallDuration("+o.IvrCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","callBlackListCustomerFlag("+o.callBlackListCustomerFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","gflowId("+o.gflowId+")"),logger.log("DEB",o.channel.id,"agent_processor","gflowName("+o.gflowName+")"),logger.log("DEB",o.channel.id,"agent_processor","gflowName("+o.endCallProvisionalFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","finalDTMF("+o.finalDTMF+")"),logger.log("DEB",o.channel.id,"agent_processor","queue_name("+o.queue_name+")"),logger.log("DEB",o.channel.id,"agent_processor","queue_id("+o.queue_id+")"),"0"!=o.voicemailRecordingFile&&"1"==o.voicemailRecordingStatus?logger.log("DEB",o.channel.id,"agent_processor","CDR needed to record for the voicemail"):logger.log("DEB",o.channel.id,"agent_processor","CDR General.."),api.logCallCdrNew(o.channel.id,o.callpatchedAgentGroup,o.callDirection,o.callDirectionStatus,o.callRecordedFileRaw,o.callRecordingStatus,o.called_number,a,o.callcdrMode,o.callchannelNo,o.callDuration,o.callendDateTimeV2,o.callHlr,o.callinsertDateTime,o.calllongcode,o.callmasterShortcode,o.callpatchedAgentId,o.callpatchedAgentName,cfg.server.self_ip,o.callshortcodeMapping,o.smeID,o.callsmeIdentifier,o.callstartDateTimeV2,o.voicemailRecordingFile,o.voicemailRecordingStatus,o.callgroupid,o.callSessionId,o.callcdrFlag,o.callanswerFlag,o.callfinalStatus,o.calldisconnectedBy,o.AgentRingingDuration,o.AgentConnectedDuration,o.CustomerRingingDuration,o.CustomerConnectedDuration,o.address_book_id,o.callType,o.endCallDescription,o.IvrCallDuration,o.callBlackListCustomerFlag,o.callModeNew,o.gflowId,o.gflowName,o.endCallProvisionalFlag,o.finalDTMF,o.callSessionId,o.queue_name,o.queue_id,l),o.gcdrStr="#WPBX#endcall#"+o.channel.id+"#"+o.callpatchedAgentGroup+"#"+o.callDirection+"#"+o.callDirectionStatus+"#"+o.callRecordedFileRaw+"#"+o.callRecordingStatus+"#"+o.called_number+"#"+a+"#"+o.callcdrMode+"#"+o.callchannelNo+"#"+o.callDuration+"#"+o.callendDateTimeV2+"#"+o.callHlr+"#"+o.callinsertDateTime+"#"+o.calllongcode+"#"+o.callmasterShortcode+"#"+o.callpatchedAgentId+"#"+cfg.server.self_ip+"#"+o.callshortcodeMapping+"#"+o.smeID+"#"+o.callsmeIdentifier+"#"+o.callstartDateTimeV2+"#"+o.voicemailRecordingFile+"#"+o.voicemailRecordingStatus+"#"+o.callgroupid+"#"+o.callSessionId+"#"+o.callcdrFlag+"#"+o.callanswerFlag+"#"+o.callfinalStatus+"#"+o.calldisconnectedBy+"#"+o.address_book_name+"#"+o.address_book_id+"#"+o.callType+"#"+o.endCallDescription+"#"+o.IvrCallDuration+"#"+o.callBlackListCustomerFlag+"#"+o.gflowId+"#"+o.gflowName+"#","1"==o.leadManagerPermissionFlag?(logger.log("DEB",o.channel.id,"agent_processor","setting updateUniqueCallDetails.. lead manager data"),api.updateUniqueCallDetails(o.channel.id,o.callpatchedAgentGroup,o.callDirection,o.callDirectionStatus,o.callRecordedFileRaw,o.callRecordingStatus,o.called_number,a,o.callcdrMode,o.callchannelNo,o.callDuration,o.callendDateTimeV2,o.callHlr,o.callinsertDateTime,o.calllongcode,o.callmasterShortcode,o.callpatchedAgentId,o.callpatchedAgentName,cfg.server.self_ip,o.callshortcodeMapping,o.smeID,o.callsmeIdentifier,o.callstartDateTimeV2,o.voicemailRecordingFile,o.voicemailRecordingStatus,o.callgroupid,o.callSessionId,o.callcdrFlag,o.callanswerFlag,o.callfinalStatus,o.calldisconnectedBy,o.address_book_name,o.address_book_id,o.callModeNew,o.endCallProvisionalFlag,o.callSessionId,o.queue_name,o.queue_id,n)):logger.log("DEB",o.channel.id,"agent_processor","("+o.leadManagerPermissionFlag+") no permission to setting updateUniqueCallDetails.. lead manager data"),logger.log("DEB",o.channel.id,"agent_processor","CDR("+o.gcdrStr+")"),"0"!=e&&e.write(o.gcdrStr)},agent_processor.prototype.addLiveCall=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [addLiveCall]"),logger.log("DEB",o.channel.id,"agent_processor","");var e="",l="",n="0";"Outgoing"==o.liveEventCallType?(e=o.customer_number,l=o.calling_number,n="20"):(e=o.calling_number,l="0"),logger.log("DEB",o.channel.id,"agent_processor","callType("+o.liveEventCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","callstartDateTime("+o.callstartDateTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerNumber("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","agentNumber("+l+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","self_ip("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function addLiveCall");api.funSetLiveCalls(o.channel.id,o.callstartDateTime,o.called_number,o.callSessionId,e,l,"0",n,o.smeID,cfg.server.self_ip,o.liveEventCallType,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(addLiveCall):"+e):logger.log("DEB",o.channel.id,"agent_processor","addLiveCall success: "+n)})},agent_processor.prototype.updateLiveCallOld=function(o,e){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [updateLiveCall]"),logger.log("DEB",o.channel.id,"agent_processor","");var l="",n="",n=(l="Outgoing"==o.liveEventCallType?o.customer_number:o.calling_number,o.idealAgentNumber);logger.log("DEB",o.channel.id,"agent_processor","liveEventCallType("+o.liveEventCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","callstartDateTime("+o.callstartDateTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerNumber("+l+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentId("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","agentNumber("+n+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","self_ip("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callStatus("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function updateLiveCall");api.funUpdateLiveCalls(o.channel.id,o.callSessionId,l,n,o.idealAgentID,e,o.smeID,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(updateLiveCall):"+e):logger.log("DEB",o.channel.id,"agent_processor","updateLiveCall success: "+n)})},agent_processor.prototype.updateLiveCall=function(o,e){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [updateLiveCallNew]"),logger.log("DEB",o.channel.id,"agent_processor","");function l(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(updateLiveCallNew):"+e):logger.log("DEB",o.channel.id,"agent_processor","updateLiveCallNew success: "+n)}var n="",a="",a=(n="Outgoing"==o.liveEventCallType?o.customer_number:o.calling_number,o.idealAgentNumber);logger.log("DEB",o.channel.id,"agent_processor","liveEventCallType("+o.liveEventCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","callstartDateTime("+o.callstartDateTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerNumber("+n+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentId("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","agentNumber("+a+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","self_ip("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callStatus("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function updateLiveCallNew");setTimeout(function(){api.funUpdateLiveCalls(o.channel.id,o.callSessionId,n,a,o.idealAgentID,e,o.smeID,o.callSessionId,o.callstartDateTime,o.called_number,cfg.server.self_ip,o.liveEventCallType,l)},1e3)},agent_processor.prototype.updateLiveCallTransfer=function(o,e){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [updateLiveCallTransfer]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","liveEventCallType("+o.liveEventCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","callstartDateTime("+o.callstartDateTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerNumber("+o.calling_number+")"),logger.log("DEB",o.channel.id,"agent_processor","transAgentId("+o.transAgentId+")"),logger.log("DEB",o.channel.id,"agent_processor","transAgentMobile("+o.transAgentMobile+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","self_ip("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callStatus("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function updateLiveCallTransfer");api.funUpdateLiveCalls(o.channel.id,o.callSessionId,o.calling_number,o.transAgentMobile,o.transAgentId,e,o.smeID,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(updateLiveCallTransfer):"+e):logger.log("DEB",o.channel.id,"agent_processor","updateLiveCallTransfer success: "+n)})},agent_processor.prototype.removeLiveCall=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [removeLiveCall]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function removeLiveCall");function e(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(removeLiveCall):"+e):logger.log("DEB",o.channel.id,"agent_processor","removeLiveCall success: "+n)}api.funDeleteLiveCalls(o.channel.id,o.callSessionId,o.smeID,o.callSessionId,e),setTimeout(function(){api.funDeleteLiveCalls(o.channel.id,o.callSessionId,o.smeID,o.callSessionId,e)},2e3)},agent_processor.prototype.addLiveCallPR=function(o,e,l,n,a,r,g,t,c,s,i){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [addLiveCallPR]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","callType("+i+")"),logger.log("DEB",o.channel.id,"agent_processor","callstartDateTime("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","customerNumber("+a+")"),logger.log("DEB",o.channel.id,"agent_processor","agentNumber("+r+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+n+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+c+")"),logger.log("DEB",o.channel.id,"agent_processor","self_ip("+s+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function addLiveCallPR");api.funSetLiveCalls(o.channel.id,e,l,n,a,r,g,t,c,s,i,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(addLiveCallPR):"+e):logger.log("DEB",o.channel.id,"agent_processor","addLiveCallPR success: "+n)})},agent_processor.prototype.updateLiveCallPR=function(o,e,l){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [updateLiveCallPR]"),logger.log("DEB",o.channel.id,"agent_processor","");var n="",a="",a=(n="Outgoing"==o.liveEventCallType?o.customer_number:o.calling_number,o.idealAgentNumber);logger.log("DEB",o.channel.id,"agent_processor","liveEventCallType("+o.liveEventCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","callstartDateTime("+o.callstartDateTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerNumber("+n+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentId("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","agentNumber("+a+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+l+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","self_ip("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callStatus("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function updateLiveCallPR");api.funUpdateLiveCalls(o.channel.id,l,n,a,o.idealAgentID,e,o.smeID,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(updateLiveCallPR):"+e):logger.log("DEB",o.channel.id,"agent_processor","updateLiveCallPR success: "+n)})},agent_processor.prototype.removeLiveCallPR=function(o,e){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [removeLiveCallPR]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function removeLiveCallPR");api.funDeleteLiveCalls(o.channel.id,e,o.smeID,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(removeLiveCallPR):"+e):logger.log("DEB",o.channel.id,"agent_processor","removeLiveCallPR success: "+n)})},agent_processor.prototype.UploadS3Recording=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [UploadS3Recording]"),logger.log("DEB",o.channel.id,"agent_processor","");logger.log("DEB",o.channel.id,"agent_processor","aAgentFlag(1)"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","idealAgentID("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","customer Number("+o.channel.caller.number+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentCallDuration("+o.AgentCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","RecordingFile("+o.s3RecordedFile+")"),logger.log("DEB",o.channel.id,"agent_processor","aRecStatus(0)"),logger.log("DEB",o.channel.id,"agent_processor","aInsertFlag(1)"),logger.log("DEB",o.channel.id,"agent_processor","selfIP("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordedFile("+o.s3RecordedFile+")"),logger.log("DEB",o.channel.id,"agent_processor","session_id("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","callDirection("+o.callDirection+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function UploadS3Recording");api.funUploadRecording(o.channel.id,"1",o.callRecordedFileRaw,o.smeID,o.idealAgentID,o.channel.caller.number,o.AgentCallDuration,o.s3RecordedFile,"0","1",cfg.server.self_ip,o.s3RecordedFile,o.callSessionId,o.callDirection,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(UploadS3Recording):"+e):logger.log("DEB",o.channel.id,"agent_processor","UploadS3Recording success: "+n)})},agent_processor.prototype.SaveS3RecordingData=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [SaveS3RecordingData]"),logger.log("DEB",o.channel.id,"agent_processor","");logger.log("DEB",o.channel.id,"agent_processor","aAgentFlag(1)"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","idealAgentID("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","customer Number("+o.channel.caller.number+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentCallDuration("+o.AgentCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","RecordingFile("+o.s3RecordedFile+")"),logger.log("DEB",o.channel.id,"agent_processor","s3uploadedUrl("+o.s3uploadedUrl+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordedFileRaw("+o.callRecordedFileRaw+")"),logger.log("DEB",o.channel.id,"agent_processor","aRecStatus(0)"),logger.log("DEB",o.channel.id,"agent_processor","aInsertFlag(1)"),logger.log("DEB",o.channel.id,"agent_processor","selfIP("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordedFile("+o.s3RecordedFile+")"),logger.log("DEB",o.channel.id,"agent_processor","session_id("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","callDirection("+o.callDirection+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function SaveS3RecordingData");api.funSaveRecordingData(o.channel.id,"1",o.callRecordedFileRaw,o.smeID,o.idealAgentID,o.channel.caller.number,o.AgentCallDuration,o.s3uploadedUrl,"0","1",cfg.server.self_ip,o.s3RecordedFile,o.callSessionId,o.callDirection,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(SaveS3RecordingData):"+e):(logger.log("DEB",o.channel.id,"agent_processor","SaveS3RecordingData success: "+n),l=o.gliveEvents.includes("evt_recording"),logger.log("DEB",o.channel.id,"agent_processor","returnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn"+l),1==l?(o.activeEvents="evt_recording",logger.log("DEB",o.channel.id,"agent_processor","SME("+o.smeID+") subscribed for evt_recording sending to CRM"),logger.log("DEB",o.channel.id,"agent_processor","initiate recording event to crm................................................."),e=dateTime.getcallDateTimeV2(),api.funcNotifyCrmIvrRecordingEvent(o.channel.id,o.activeEvents,o.crmPartner,o.smeID,o.accountSid,o.callSessionId,o.s3uploadedUrl,"0",o.idealAgentNumber,o.calling_number,o.calllongcode,o.callstartDateTimeV2,e,o.callType,o.callMode,"RECORDING",o.callDuration,"0","0",o.triedAgentArray,o.callSessionId,o.callRecordedFileRaw,o.callSessionId)):logger.log("DEB",o.channel.id,"agent_processor","SME("+o.smeID+") not subscribed for evt_recording from("+o.gliveEvents+")"))})},agent_processor.prototype.SaveS3FailedRecordingData=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [SaveS3FailedRecordingData]"),logger.log("DEB",o.channel.id,"agent_processor","");logger.log("DEB",o.channel.id,"agent_processor","aAgentFlag(1)"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","idealAgentID("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","customer Number("+o.channel.caller.number+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentCallDuration("+o.AgentCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","RecordingFile("+o.s3RecordedFile+")"),logger.log("DEB",o.channel.id,"agent_processor","s3uploadedUrl("+o.s3uploadedUrl+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordedFileRaw("+o.callRecordedFileRaw+")"),logger.log("DEB",o.channel.id,"agent_processor","aRecStatus(0)"),logger.log("DEB",o.channel.id,"agent_processor","aInsertFlag(1)"),logger.log("DEB",o.channel.id,"agent_processor","selfIP("+cfg.server.self_ip+")"),logger.log("DEB",o.channel.id,"agent_processor","callRecordedFile("+o.s3RecordedFile+")"),logger.log("DEB",o.channel.id,"agent_processor","session_id("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","callDirection("+o.callDirection+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function SaveS3FailedRecordingData");api.funSaveFailedRecordingData(o.channel.id,"1",o.callRecordedFileRaw,o.smeID,o.idealAgentID,o.channel.caller.number,o.AgentCallDuration,o.s3RecordedFile,"0","1",cfg.server.self_ip,o.s3RecordedFile,o.callSessionId,o.callDirection,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(SaveS3FailedRecordingData):"+e):logger.log("DEB",o.channel.id,"agent_processor","SaveS3FailedRecordingData success: "+n)})},agent_processor.prototype.logAgentCdr=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [logAgentCdr]"),logger.log("DEB",o.channel.id,"agent_processor",""),o.AgentEndCallTime=dateTime.getAgentDateTime(),o.AgentCallDuration=dateTime.calculateDuration(o.AgentStartCallTime,o.AgentEndCallTime),logger.log("DEB",o.channel.id,"agent_processor","Agent Number("+o.idealAgentNumber+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent ID("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent Group("+o.idealAgentGroup+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent Status("+o.idealAgentStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent Masking("+o.idealAgentMasking+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent Sticky("+o.stickyAgentFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","Customer Sticky("+o.customerStickyFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","Customer callRouteReason("+o.callRouteReason),logger.log("DEB",o.channel.id,"agent_processor","queue_name("+o.queue_name+")"),logger.log("DEB",o.channel.id,"agent_processor","queue_id("+o.queue_id+")");var e="0",l=!1,l=(1==(l=o.all_call_mode?o.all_call_mode.includes("CRM_APP"):l)&&(logger.log("DEB",o.channel.id,"main","CRM_APP Call Mode: "+l+"   ("+o.calling_number+")"),e=o.calling_number),"0"),n="",l="0"==o.AgentStatus?"answered":"failed",a="0";"outgoing"==o.callInfo&&"WRINGG_APP"==o.callMode?(n=o.customer_number,a="2"==o.callanswerFlag?"success":"failed"):n=o.channel.caller.number,logger.log("DEB",o.channel.id,"agent_processor","Agent final status("+l+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentRingingDuration("+o.AgentRingingDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentConnectedDuration("+o.AgentConnectedDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","idealAgentReportFlag("+o.idealAgentReportFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","idealAgentID("+o.idealAgentID+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentStatus("+o.AgentStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","agentCallResponseCode("+o.agentCallResponseCode+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentStartCallTime("+o.AgentStartCallTime+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentEndCallTime("+o.AgentEndCallTime+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentCallDuration("+o.AgentCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","catDescAgent as groupId("+o.catDescAgent+")"),logger.log("DEB",o.channel.id,"agent_processor","customer Number("+n+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","callMode("+o.callMode+")"),logger.log("DEB",o.channel.id,"agent_processor","callInfo("+o.callInfo+")"),logger.log("DEB",o.channel.id,"agent_processor","tmpOverallCallStatus("+a+")"),logger.log("DEB",o.channel.id,"agent_processor","tmp_agent_no("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","Calling db function setAgentCdr with Param AgentID("+o.idealAgentID+"), catDesc("+o.catDescAgent+"), agentrepeatid(0), flag(2), alogtype("+o.smeAlgorithm+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent Leg CDR #"+o.idealAgentReportFlag+"#"+o.smeID+"#"+o.idealAgentID+"#"+o.AgentStatus+"#"+o.agentCallResponseCode+"#"+o.AgentStartCallTime+"#"+o.AgentEndCallTime+"#"+o.AgentCallDuration+"#"+o.catDescAgent+"#"+n+"#"+o.callSessionId+"#"+o.callMode+"#"+o.callInfo+"#");api.funSetAgentCdr(o.channel.id,o.idealAgentReportFlag,o.smeID,o.idealAgentID,o.AgentStatus,o.agentCallResponseCode,o.AgentStartCallTime,o.AgentEndCallTime,o.AgentCallDuration,o.idealAgentGroup,n,o.callSessionId,o.callMode,o.callInfo,o.AgentRingingDuration,o.AgentConnectedDuration,o.callRouteReason,a,e,o.callSessionId,o.queue_name,o.queue_id,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(logAgentCdr):"+e):logger.log("DEB",o.channel.id,"agent_processor","logAgentCdr success: "+n)})},agent_processor.prototype.logAgentCdrPR=function(o,e,l,n,a,r,g,t,c,s,i,d,p,u,D,_,h,m,E){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [logAgentCdrPR - Parallel Ringing]"),logger.log("DEB",o.channel.id,"agent_processor","");var B="",C="0";"outgoing"==o.callInfo&&"WRINGG_APP"==o.callMode?(B=o.customer_number,C="2"==o.callanswerFlag?"success":"failed"):B=o.channel.caller.number;api.funSetAgentCdr(o.channel.id,e,l,n,a,r,g,t,c,s,B,d,p,u,D,_,E,C,"0",o.callSessionId,h,m,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(logAgentCdr):"+e):logger.log("DEB",o.channel.id,"agent_processor","logAgentCdr success: "+n)})},agent_processor.prototype.logAgentCdrTransfer=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [logAgentCdrTransfer]"),logger.log("DEB",o.channel.id,"agent_processor",""),o.AgentEndCallTime=dateTime.getAgentDateTime(),o.AgentCallDuration=dateTime.calculateDuration(o.TransferAgentStartTime,o.AgentEndCallTime),logger.log("DEB",o.channel.id,"agent_processor","Agent Number("+o.idealAgentNumber),logger.log("DEB",o.channel.id,"agent_processor","Agent ID("+o.idealAgentID),logger.log("DEB",o.channel.id,"agent_processor","Agent Group("+o.idealAgentGroup),logger.log("DEB",o.channel.id,"agent_processor","Agent Status("+o.idealAgentStatus),logger.log("DEB",o.channel.id,"agent_processor","Agent Masking("+o.idealAgentMasking),logger.log("DEB",o.channel.id,"agent_processor","Agent Sticky("+o.stickyAgentFlag),logger.log("DEB",o.channel.id,"agent_processor","Customer Sticky("+o.customerStickyFlag);o.CDRAnswerFlag,logger.log("DEB",o.channel.id,"agent_processor","TransferAgentRingingDuration("+o.TransferAgentRingingDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","TransferAgentConnectedDuration("+o.TransferAgentConnectedDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","idealAgentReportFlag("+o.idealAgentReportFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","transAgentId("+o.transAgentId+")"),logger.log("DEB",o.channel.id,"agent_processor","transAgenAnswerStatus("+o.transAgenAnswerStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","agentCallResponseCode("+o.agentCallResponseCode+")"),logger.log("DEB",o.channel.id,"agent_processor","TransferAgentStartTime("+o.TransferAgentStartTime+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentEndCallTime("+o.AgentEndCallTime+")"),logger.log("DEB",o.channel.id,"agent_processor","AgentCallDuration("+o.AgentCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","transAgentGroup("+o.transAgentGroup+")"),logger.log("DEB",o.channel.id,"agent_processor","customer Number("+o.channel.caller.number+")"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","callMode("+o.callMode+")"),logger.log("DEB",o.channel.id,"agent_processor","callInfo("+o.callInfo+")"),logger.log("DEB",o.channel.id,"agent_processor","tmpOverallCallStatus(0)"),logger.log("DEB",o.channel.id,"agent_processor","queue_name("+o.queue_name+")"),logger.log("DEB",o.channel.id,"agent_processor","queue_id("+o.queue_id+")"),logger.log("DEB",o.channel.id,"agent_processor","Agent Leg CDR #"+o.idealAgentReportFlag+"#"+o.smeID+"#"+o.transAgentId+"#"+o.transAgenAnswerStatus+"#"+o.agentCallResponseCode+"#"+o.TransferAgentStartTime+"#"+o.AgentEndCallTime+"#"+o.AgentCallDuration+"#"+o.transAgentGroup+"#"+o.channel.caller.number+"#"+o.callSessionId+"#"+o.callMode+"#"+o.callInfo+"#");api.funSetAgentCdr(o.channel.id,o.idealAgentReportFlag,o.smeID,o.transAgentId,o.transAgenAnswerStatus,o.agentCallResponseCode,o.TransferAgentStartTime,o.AgentEndCallTime,o.AgentCallDuration,o.transAgentGroup,o.channel.caller.number,o.callSessionId,o.callMode,o.callInfo,o.TransferAgentRingingDuration,o.TransferAgentConnectedDuration,o.callRouteReason,"0","0",o.callSessionId,o.queue_name,o.queue_id,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(logAgentCdr):"+e):logger.log("DEB",o.channel.id,"agent_processor","logAgentCdr success: "+n)})},agent_processor.prototype.funcNotifyAutodialer=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [funcNotifyAutodialer]"),logger.log("DEB",o.channel.id,"agent_processor",""),o.AgentEndCallTime=dateTime.getAgentDateTime(),o.AgentCallDuration=dateTime.calculateDuration(o.AgentStartCallTime,o.AgentEndCallTime),logger.log("DEB",o.channel.id,"agent_processor","smeId("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","adSchedulerId("+o.adSchedulerId+")");api.notifyCustomerCrmDialer(o.channel.id,o.smeID,o.adSchedulerId,o.adSessionId,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(funcNotifyAutodialer):"+e):logger.log("DEB",o.channel.id,"agent_processor","funcNotifyAutodialer success: "+n)})},agent_processor.prototype.funcNotifyCrmIncomingCalls=function(e,l){var n;logger.log("DEB",e.channel.id,"agent_processor",""),logger.log("DEB",e.channel.id,"agent_processor","Internal Function [funcNotifyCrmIncomingCalls]"),logger.log("DEB",e.channel.id,"agent_processor",""),e.AgentEndCallTime=dateTime.getAgentDateTime(),e.AgentCallDuration=dateTime.calculateDuration(e.AgentStartCallTime,e.AgentEndCallTime),logger.log("DEB",e.channel.id,"agent_processor","smeId("+e.smeID+")"),logger.log("DEB",e.channel.id,"agent_processor","adSchedulerId("+e.adSchedulerId+")"),"evt_invite"==l?(n=dateTime.getcallDateTimeCRM(),api.funcNotifyCrmIncomingCallsApi(e.channel.id,l,e.crmPartner,e.smeID,e.accountSid,e.callSessionId,"0","0","0",e.calling_number,e.called_number,n,"0",e.callType,e.callMode,"NEW CALL","0","0","0","0",e.callSessionId,"0",e.callSessionId)):"evt_connected"==l?(n=dateTime.getcallDateTimeCRM(),api.funcNotifyCrmIncomingCallsApi(e.channel.id,l,e.crmPartner,e.smeID,e.accountSid,e.callSessionId,"0","0",e.idealAgentNumber,e.calling_number,e.called_number,n,"0",e.callType,e.callMode,"CALL CONNECTED","0","0","0","0",e.callSessionId,e.idealAgentNumber,e.callSessionId)):"evt_popup"==l?(n=dateTime.getcallDateTimeCRM(),api.funcNotifyCrmIncomingCallsApi(e.channel.id,l,e.crmPartner,e.smeID,e.accountSid,e.callSessionId,"0","0",e.idealAgentNumber,e.calling_number,e.called_number,n,"0",e.callType,e.callMode,e.callStatusCRM,"0","0","0","0",e.callSessionId,e.idealAgentNumber,e.callSessionId)):"evt_completed"==l?(n=dateTime.getcallDateTimeCRM(),api.funcNotifyCrmIncomingCallsApi(e.channel.id,l,e.crmPartner,e.smeID,e.accountSid,e.callSessionId,e.adRecordingFileId,"0",e.idealAgentNumber,e.calling_number,e.calllongcode,e.callstartDateTimeCRM,n,e.callType,e.callMode,e.callStatusCRM,e.callDuration,"0","0",e.triedAgentArray,e.callSessionId,e.idealAgentNumber,e.callSessionId)):"evt_endcall"==l?(n=dateTime.getcallDateTimeCRM(),api.funcNotifyCrmIncomingCallsApi(e.channel.id,l,e.crmPartner,e.smeID,e.accountSid,e.callSessionId,e.adRecordingFileId,"0",e.idealAgentNumber,e.calling_number,e.calllongcode,e.callstartDateTimeCRM,n,e.callType,e.callMode,e.callStatusCRM,e.callDuration,"0","0",e.triedAgentArray,e.callSessionId,"0",e.callSessionId)):"evt_recording"==l&&(n=dateTime.getcallDateTimeCRM(),api.funcNotifyCrmIvrRecordingEvent(e.channel.id,l,e.crmPartner,e.smeID,e.accountSid,e.callSessionId,e.s3uploadedUrl,"0",e.idealAgentNumber,e.calling_number,e.calllongcode,e.callstartDateTimeCRM,n,e.callType,e.callMode,e.callStatusCRM,e.callDuration,"0","0",e.triedAgentArray,e.callSessionId,callRecordedFileRaw,e.callSessionId))},agent_processor.prototype.funEndCallNotification=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [funEndCallNotification]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function removeLiveCall");api.sendEndCallNotification(o.channel.id,"outgoing",o.smeID,o.callSessionId,o.callpatchedAgentId,"",o.customer_number,"APP",o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(funEndCallNotification):"+e):logger.log("DEB",o.channel.id,"agent_processor","funEndCallNotification success: "+n)})},agent_processor.prototype.funEndCallSMS=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [funEndCallSMS]"),logger.log("DEB",o.channel.id,"agent_processor","");var e="";"1"==o.callanswerFlag&&"OUTGOING"==o.callDirection?e="FAILED":"2"==o.callanswerFlag&&"OUTGOING"==o.callDirection?e="SUCCESS":"2"==o.callanswerFlag&&"INCOMING"==o.callDirection?e="FAILED":"1"==o.callanswerFlag&&"INCOMING"==o.callDirection&&(e="SUCCESS"),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function removeLiveCall");api.sendEndCallSMS(o.channel.id,o.callDirection,o.smeID,e,o.calling_number,o.idealAgentNumber,o.idealAgentName,o.AgentConnectedDuration,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(funEndCallSMS):"+e):logger.log("DEB",o.channel.id,"agent_processor","funEndCallSMS success: "+n)})},agent_processor.prototype.funEndCallSMSexternal=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [funEndCallSMSexternal]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function removeLiveCall");var e="";"1"==o.callanswerFlag&&"OUTGOING"==o.callDirection?e="FAILED":"2"==o.callanswerFlag&&"OUTGOING"==o.callDirection?e="SUCCESS":"2"==o.callanswerFlag&&"INCOMING"==o.callDirection?e="FAILED":"1"==o.callanswerFlag&&"INCOMING"==o.callDirection&&(e="SUCCESS"),api.sendEndCallSmsExternal(o.channel.id,o.callDirection,o.smeID,e,o.calling_number,o.idealAgentNumber,o.idealAgentName,o.AgentConnectedDuration,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(funEndCallSMSexternal):"+e):logger.log("DEB",o.channel.id,"agent_processor","funEndCallSMSexternal success: "+n)})},agent_processor.prototype.markAgentBusy=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [markAgentBusy]"),logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function markAgentBusy");api.funSetAgentBusy(o.channel.id,o.idealAgentNumber,o.smeID,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(markAgentBusy):"+e):logger.log("DEB",o.channel.id,"agent_processor","markAgentBusy success: "+n)})},agent_processor.prototype.logCustomerCdr=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [logCustomerCdr]"),logger.log("DEB",o.channel.id,"agent_processor",""),o.AgentEndCallTime=dateTime.getAgentDateTime(),o.AgentCallDuration=dateTime.calculateDuration(o.AgentStartCallTime,o.AgentEndCallTime);o.AgentStatus;var e="IVR_APP";null==o.agentCallResponseCode&&(o.agentCallResponseCode="16"),""!=o.customerCallDuration&&null!=o.customerCallDuration&&" "!=o.customerCallDuration||(o.customerCallDuration=0),""!=o.CustomerRingingDuration&&null!=o.CustomerRingingDuration&&" "!=o.CustomerRingingDuration||(o.CustomerRingingDuration=0),logger.log("DEB",o.channel.id,"agent_processor","before customerConnectedDuration("+o.CustomerConnectedDuration+")"),""!=o.CustomerConnectedDuration&&null!=o.CustomerConnectedDuration&&" "!=o.CustomerConnectedDuration&&"NaN"!=o.CustomerConnectedDuration||(o.CustomerConnectedDuration=0),logger.log("DEB",o.channel.id,"agent_processor","customerReportFlag("+o.customerReportFlag+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","customerStatus("+o.customerStatus+")"),logger.log("DEB",o.channel.id,"agent_processor","customerCallResponseCode("+o.customerCallResponseCode+")"),logger.log("DEB",o.channel.id,"agent_processor","customerStartCallTime("+o.customerStartCallTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerEndCallTime("+o.customerEndCallTime+")"),logger.log("DEB",o.channel.id,"agent_processor","customerCallDuration("+o.customerCallDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","customer_number("+o.customer_number+")"),logger.log("DEB",o.channel.id,"agent_processor","sessionCall("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","callMode("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","callInfo("+o.callInfo+")"),logger.log("DEB",o.channel.id,"agent_processor","CustomerRingingDuration("+o.CustomerRingingDuration+")"),logger.log("DEB",o.channel.id,"agent_processor","customerConnectedDuration("+o.CustomerConnectedDuration+")");api.funSetCustomerCdr(o.channel.id,o.customerReportFlag,o.smeID,o.customerStatus,o.customerCallResponseCode,o.customerStartCallTime,o.customerEndCallTime,o.customerCallDuration,o.customer_number,o.callSessionId,e,o.callInfo,o.CustomerRingingDuration,o.CustomerConnectedDuration,o.customerCallRouteReason,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(logCustomerCdr):"+e):logger.log("DEB",o.channel.id,"agent_processor","logCustomerCdr success: "+n)})},agent_processor.prototype.deductCallBalance=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [deductCallBalance]"),logger.log("DEB",o.channel.id,"agent_processor","");var e="0",e=0!=o.AgentConnectedStartTime?(o.AgentConnectedEndTime=dateTime.getAgentDateTime(),dateTime.calculateDuration(o.AgentConnectedStartTime,o.AgentConnectedEndTime)):o.AgentConnectedDuration;logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","callDuration("+e+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function deductCallBalance");api.updateCallBalance(o.channel.id,e,o.planTypeDetail,o.smeID,o.callSessionId,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(deductCallBalance):"+e):logger.log("DEB",o.channel.id,"agent_processor","deductCallBalance success: "+n)})},agent_processor.prototype.aiBotCallStartFun=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [aiBotCallStartFun]"),logger.log("DEB",o.channel.id,"agent_processor","");0!=o.AgentConnectedStartTime?(o.AgentConnectedEndTime=dateTime.getAgentDateTime(),dateTime.calculateDuration(o.AgentConnectedStartTime,o.AgentConnectedEndTime)):o.AgentConnectedDuration,logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","address_book_name("+o.address_book_name+")"),logger.log("DEB",o.channel.id,"agent_processor","calling_number("+o.calling_number+")"),logger.log("DEB",o.channel.id,"agent_processor","called_number("+o.called_number+")"),logger.log("DEB",o.channel.id,"agent_processor","recordingEndPoint("+o.recordingEndPoint+")"),logger.log("DEB",o.channel.id,"agent_processor","aiBotCallType("+o.aiBotCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function aiBotCallStartFun");api.aiBotCallStart(o.channel.id,aiBotCallType,o.smeID,o.callSessionId,o.address_book_name,o.calling_number,o.called_number,recordingEndPoint,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(aiBotCallStartFun):"+e):logger.log("DEB",o.channel.id,"agent_processor","aiBotCallStartFun success: "+n)})},agent_processor.prototype.aiBotStartMediatFun=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [aiBotSendMediatFun]"),logger.log("DEB",o.channel.id,"agent_processor","");0!=o.AgentConnectedStartTime?(o.AgentConnectedEndTime=dateTime.getAgentDateTime(),dateTime.calculateDuration(o.AgentConnectedStartTime,o.AgentConnectedEndTime)):o.AgentConnectedDuration,logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","recordingEndPoint("+o.recordingEndPoint+")"),logger.log("DEB",o.channel.id,"agent_processor","aiBotCallType("+o.aiBotCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function aiBotSendMediatFun");api.aiBotStartMedia(o.channel.id,aiBotCallType,o.smeID,o.callSessionId,recordingEndPoint,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(aiBotSendMediatFun):"+e):logger.log("DEB",o.channel.id,"agent_processor","aiBotSendMediatFun success: "+n)})},agent_processor.prototype.aiBotCallStopFun=function(o){logger.log("DEB",o.channel.id,"agent_processor",""),logger.log("DEB",o.channel.id,"agent_processor","Internal Function [aiBotCallStopFun]"),logger.log("DEB",o.channel.id,"agent_processor","");0!=o.AgentConnectedStartTime?(o.AgentConnectedEndTime=dateTime.getAgentDateTime(),dateTime.calculateDuration(o.AgentConnectedStartTime,o.AgentConnectedEndTime)):o.AgentConnectedDuration,logger.log("DEB",o.channel.id,"agent_processor","callSessionId("+o.callSessionId+")"),logger.log("DEB",o.channel.id,"agent_processor","smeID("+o.smeID+")"),logger.log("DEB",o.channel.id,"agent_processor","recordingEndPoint("+o.recordingEndPoint+")"),logger.log("DEB",o.channel.id,"agent_processor","aiBotCallType("+o.aiBotCallType+")"),logger.log("DEB",o.channel.id,"agent_processor","inside function aiBotCallStopFun");api.aiBotCallStop(o.channel.id,aiBotCallType,o.smeID,o.callSessionId,recordingEndPoint,function(e,l,n){e||200!=l.statusCode?logger.log("ERR",o.channel.id,"agent_processor","Error thrown at url call(aiBotCallStopFun):"+e):logger.log("DEB",o.channel.id,"agent_processor","aiBotCallStopFun success: "+n)})};