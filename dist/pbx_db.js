const mariadb=require("mysql");var cfg=require("../../pbx_config"),querystring=require("querystring"),pbx_logger=require("./logger/pbx_logger.js"),logger=new pbx_logger,gDbConn=(module.exports=pbx_db,""),gDbPool="";function pbx_db(){if(!(this instanceof pbx_db))return new pbx_db}pbx_db.prototype.connect=function(){logger.log("IMP",0,"db","Internal Function [connect]"),logger.log("DEB",0,"db","host: "+cfg.database.host),logger.log("DEB",0,"db","user: "+cfg.database.user),logger.log("DEB",0,"db","pass: "+cfg.database.password),logger.log("DEB",0,"db","limit: "+cfg.database.limit),logger.log("DEB",0,"db","db: "+cfg.database.db),gDbPool=mariadb.createPool({host:cfg.database.host,user:cfg.database.user,password:cfg.database.password,connectionLimit:cfg.database.limit,database:cfg.database.db})},pbx_db.prototype.reconnect=function(){logger.log("IMP",0,"db","Internal Function [reconnect]"),logger.log("DEB",0,"db","host: "+cfg.database.host),logger.log("DEB",0,"db","user: "+cfg.database.user),logger.log("DEB",0,"db","pass: "+cfg.database.password),logger.log("DEB",0,"db","limit: "+cfg.database.limit),logger.log("DEB",0,"db","db: "+cfg.database.db),gDbPool.end(),gDbPool=mariadb.createPool({host:cfg.database.host,user:cfg.database.user,password:cfg.database.password,connectionLimit:cfg.database.limit,database:cfg.database.db})},pbx_db.prototype.getClicktoCall=function(o,a,r,t,l,s,b,d,n,c,i,f,u){logger.log("IMP",r,"db","Internal Function [getClicktoCall]"),logger.log("DEB",r,"db","Inside getClicktoCall c2c_mode("+o+"), call_flag("+a+"), channel("+r+"), sme_id("+t+"), session_id("+l+"), scheduler_id("+s+"), call_duration("+b+"), dtmf("+d+"), recording_file("+n+"), call_status("+c+"), agent_no("+i+"), virtual_no("+f+") "),gDbPool.getConnection(function(e,g){if(e)throw e;g.query("CALL KOMM_GET_C2C_new(?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",[o,a,t,l,s,b,d,n,c,i,f],function(e,o,a){if(g.release(),e)throw u("Error",e),e;var t;result&&(Object.keys(o[0]).forEach(function(e){t=o[0][e],logger.log("DEB",r,"db","row in output:"+t.result)}),u(null,t.result))})})};