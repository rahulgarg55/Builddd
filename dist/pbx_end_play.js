var Event=require("./events"),cfg=require("../../pbx_config"),pbx_db=require("./pbx_db"),pbx_api=require("./api/pbx_api"),pbx_logger=require("./logger/pbx_logger"),express=require("express"),ari=require("ari-client"),util=require("util"),path=require("path"),fs=require("fs"),mv=require("mv"),logger=new pbx_logger,dbOutput="",dbSMEid="",gcatId="",gcatDesc="",gparentCatId="",gvalidDtmf="",gchildrenStatus="",gmediaFile="",eventType="",flowType="",vm_recording="";function EndPlay(i){this.state_name="end_play_state",this.enter=function(){var n,l,e;new pbx_db;function a(e,n){logger.log("IMP",i.channel.id,"end_play","Inside on_hangup"),logger.log("DEB",n.id,"end_play","1 calldisconnectedBy:"+n.calldisconnectedBy),logger.log("DEB",n.id,"end_play","2 calldisconnectedBy:"+i.calldisconnectedBy),logger.log("DEB",n.id,"end_play","3 calldisconnectedBy:"+i.channel.calldisconnectedBy),logger.log("DEB",i.channel.id,"end_play","State-Machine Update to ==> [Event.HANGUP]"),i.state_machine.change_state(Event.HANGUP)}logger.log("IMP",i.channel.id,"end_play","Entering user_end_play_state: end_play_state"),logger.log("DEB",i.channel.id,"end_play","Uniqe Session ID: "+i.channel.callSessionId),i.channel.on("ChannelHangupRequest",a),i.channel.on("ChannelDestroyed",a),i.client.on("PlaybackFinished",function(e){l&&l.id===e.playback.id&&i.channel&&logger.log("DEB",i.channel.id,"end_play","Play Promot ("+n+") finished");logger.log("IMP",i.channel.id,"end_play","Inside cleanup function"),i.channel.removeListener("ChannelHangupRequest",a),i.channel.hangup(function(e){})}),i.language="e",e=i.currentState,logger.log("IMP",i.channel.id,"end_play","Current state for start_playback is: "+e),logger.log("IMP",i.channel.id,"end_play","Play: ("+cfg.outgoing.could_not_connect_customer+") Path: ("+cfg.media.dir+")"),n="sound:"+cfg.media.dir+"/"+cfg.outgoing.could_not_connect_customer+"-"+i.language,logger.log("IMP",i.channel.id,"end_play","Going to play media ["+n+"]"),l=null,l=i.client.Playback(),logger.log("DEB",i.channel.id,"end_play","channel:",i.channel.caller),i.channel.play({media:n},l,function(e,n){logger.log("ERR",i.channel.id,"end_play","In Playback Handler:"+e)})}}module.exports=EndPlay;