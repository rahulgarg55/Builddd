var Event=require("./events"),cfg=require("../../pbx_config"),pbx_db=require("./pbx_db"),pbx_api=require("./api/pbx_api"),pbx_logger=require("./logger/pbx_logger"),express=require("express"),dt=require("./common/datetime"),ari=require("ari-client"),util=require("util"),path=require("path"),fs=require("fs"),mv=require("mv"),logger=new pbx_logger,dateTime=new dt,dbOutput="",dbSMEid="",mobile_counter=0,api=new pbx_api,current_sound="";function AgentIncomingIvr(r){this.state_name="agent_ivr_state",logger.log("DEB",r.channel.id,"agent_ivr","Current State ["+r.currentState+"] Update to ==> [dialing]"),this.enter=function(){var g;new pbx_db;function t(e){logger.log("IMP",r.channel.id,"agent_ivr","Internal Function [start_playback]"),"AGENT_WELCOME"===r.callagentincomingstate?(logger.log("DEB",r.channel.id,"agent_ivr","Current Agent Incoming State (AGENT_WELCOME)"),logger.log("IMP",r.channel.id,"agent_ivr","Current state for start_playback is: "+e),logger.log("IMP",r.channel.id,"agent_ivr","Play: ("+cfg.outgoing.welcome+") Path: ("+cfg.media.dir+")"),current_sound="sound:"+cfg.media.dir+"/"+cfg.outgoing.welcome+"-"+r.language,logger.log("IMP",r.channel.id,"agent_ivr","Going to play media ["+current_sound+"]"),g=null,g=r.client.Playback(),logger.log("DEB",r.channel.id,"agent_ivr","channel:",r.channel.caller),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),logger.log("IMP",r.channel.id,"agent_ivr","PLAY ["+current_sound+"]"),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),r.channel.play({media:current_sound},g,function(e,n){logger.log("ERR",r.channel.id,"agent_ivr","AGENT_WELCOME...In Playback Handler:"+e)})):"AGENT_ENTERED_NUMBER"===r.callagentincomingstate?(logger.log("DEB",r.channel.id,"agent_ivr","Current Agent Incoming State (AGENT_ENTERED_NUMBER)"),logger.log("IMP",r.channel.id,"agent_ivr","Current state for start_playback is: "+e),logger.log("IMP",r.channel.id,"agent_ivr","Play: ("+cfg.outgoing.entered_number_is+") Path: ("+cfg.media.dir+")"),current_sound="sound:"+cfg.media.dir+"/"+cfg.outgoing.entered_number_is+"-"+r.language,logger.log("IMP",r.channel.id,"agent_ivr","Going to play media ["+current_sound+"]"),g=null,g=r.client.Playback(),logger.log("DEB",r.channel.id,"agent_ivr","channel:",r.channel.caller),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),logger.log("IMP",r.channel.id,"agent_ivr","PLAY ["+current_sound+"]"),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),r.channel.play({media:current_sound},g,function(e,n){logger.log("ERR",r.channel.id,"agent_ivr","AGENT_ENTERED_NUMBER...In Playback Handler:"+e)})):"AGENT_TRANSFER_PLAY"===r.callagentincomingstate?(logger.log("DEB",r.channel.id,"agent_ivr","Current Agent Incoming State (AGENT_TRANSFER_PLAY)"),logger.log("IMP",r.channel.id,"agent_ivr","Current state for start_playback is: "+e),logger.log("IMP",r.channel.id,"agent_ivr","Play: ("+cfg.outgoing.transferring_call+") Path: ("+cfg.media.dir+")"),current_sound="sound:"+cfg.media.dir+"/"+cfg.outgoing.transferring_call+"-"+r.language,logger.log("IMP",r.channel.id,"agent_ivr","Going to play media ["+current_sound+"]"),g=null,g=r.client.Playback(),logger.log("DEB",r.channel.id,"agent_ivr","channel:",r.channel.caller),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),logger.log("IMP",r.channel.id,"agent_ivr","PLAY ["+current_sound+"]"),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),r.channel.play({media:current_sound},g,function(e,n){e?logger.log("ERR",r.channel.id,"agent_ivr","AGENT_TRANSFER_PLAY...In Playback Handler:"+e):logger.log("IMP",r.channel.id,"agent_ivr","[AGENT_TRANSFER_PLAY] ("+current_sound+") Playing(0)")})):"PLAY_DIGITS"===r.callagentincomingstate&&(logger.log("DEB",r.channel.id,"agent_ivr","Current Agent Incoming State (PLAY_DIGITS)"),logger.log("IMP",r.channel.id,"agent_ivr","Current state for start_playback is: "+e),mobile_counter>=cfg.outgoing.number_length?(current_sound="sound:"+cfg.media.dir+"/"+cfg.outgoing.entered_number_confirm+"-"+r.language,logger.log("DEB",r.channel.id,"agent_ivr","Update state from [PLAY_DIGITS] to [CONFIRM_DIGIT]"),r.callagentincomingstate="CONFIRM_DIGIT"):(current_digit=r.gvalidDtmf[mobile_counter],mobile_counter++,current_sound="sound:"+cfg.media.dir+"/digits/"+current_digit+"-"+r.language),logger.log("IMP",r.channel.id,"agent_ivr","Going to play media digit["+current_sound+"]"),g=null,g=r.client.Playback(),logger.log("DEB",r.channel.id,"agent_ivr","channel:",r.channel.caller),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),logger.log("IMP",r.channel.id,"agent_ivr","PLAY ["+current_sound+"]"),logger.log("IMP",r.channel.id,"agent_ivr","--------------------------------------"),r.channel.play({media:current_sound},g,function(e,n){logger.log("ERR",r.channel.id,"agent_ivr","PLAY_DIGITS...In Playback Handler:"+e)}))}function a(e){logger.log("IMP",r.channel.id,"agent_ivr","ON Event [on_playback_finished]"),g&&g.id===e.playback.id&&r.channel&&logger.log("DEB",r.channel.id,"agent_ivr","Play Promot ("+current_sound+") finished"),"PLAY_DIGITS"===r.callagentincomingstate?t(r.currentState):"AGENT_ENTERED_NUMBER"===r.callagentincomingstate?(logger.log("DEB",r.channel.id,"agent_ivr","Update state from [AGENT_ENTERED_NUMBER] to [PLAY_DIGITS]"),r.callagentincomingstate="PLAY_DIGITS",t(r.currentState)):"AGENT_TRANSFER_PLAY"===r.callagentincomingstate&&(logger.log("DEB",r.channel.id,"agent_ivr","Update state from [AGENT_TRANSFER_PLAY] to [MAKE_OUTGOING_CALL]"),r.callagentincomingstate="MAKE_OUTGOING_CALL",logger.log("IMP",r.channel.id,"agent_ivr","State-Machine Update to ==> [Event.MAKE_CALL]"),r.state_machine.change_state(Event.MAKE_CALL))}function l(e,n){if(logger.log("IMP",r.channel.id,"agent_ivr","ON Event [on_dtmf]"),logger.log("IMP",r.channel.id,"agent_ivr","DTMF EVENT ["+e.digit+"] ["+current_sound+"]"),"AGENT_ENTERED_NUMBER"===r.callagentincomingstate)logger.log("DEB",r.channel.id,"agent_ivr","Update state from [AGENT_ENTERED_NUMBER] to [PLAY_DIGITS]"),r.callagentincomingstate="PLAY_DIGITS",t(r.currentState);else if("CONFIRM_DIGIT"===r.callagentincomingstate)switch(g&&r.channel&&(logger.log("DEB",r.channel.id,"agent_ivr","stopping playing file ("+cfg.outgoing.welcome+")"),g.stop()),e.digit){case"1":r.customer_number=r.gvalidDtmf,logger.log("DEB",r.channel.id,"agent_ivr","Agent confirmed dtmf ("+e.digit+") for valid mobile number ("+r.customer_number+")"),logger.log("DEB",r.channel.id,"agent_ivr","Update state from [CONFIRM_DIGIT] to [AGENT_TRANSFER_PLAY]"),r.callagentincomingstate="AGENT_TRANSFER_PLAY",t(r.currentState);break;case"2":logger.log("DEB",r.channel.id,"agent_ivr","Agent dtmf("+e.digit+") need to re-enter mobile number ("+r.customer_number+")"),logger.log("DEB",r.channel.id,"agent_ivr","Update state from [CONFIRM_DIGIT] to [AGENT_WELCOME]"),r.callagentincomingstate="AGENT_WELCOME",r.gvalidDtmf="",mobile_counter=0,t(r.currentState)}else"AGENT_WELCOME"===r.callagentincomingstate&&(r.gvalidDtmf=r.gvalidDtmf+e.digit,logger.log("DEB",r.channel.id,"agent_ivr","if ("+r.gvalidDtmf.length+") === ("+cfg.outgoing.number_length+")"),r.gvalidDtmf.length>=cfg.outgoing.number_length?(logger.log("DEB",r.channel.id,"agent_ivr","Complete MobileNumber Received ("+r.gvalidDtmf+") & length ("+r.gvalidDtmf.length+")"),logger.log("DEB",r.channel.id,"agent_ivr","Update state from [AGENT_WELCOME] to [AGENT_ENTERED_NUMBER]"),r.callagentincomingstate="AGENT_ENTERED_NUMBER",t(r.currentState)):logger.log("DEB",r.channel.id,"agent_ivr","MobileNumber Received so far ("+r.gvalidDtmf+") & length ("+r.gvalidDtmf.length+") but not ("+cfg.outgoing.number_length+")"))}function i(e,n){logger.log("IMP",r.channel.id,"agent_ivr","ON Event [on_hangup]"),logger.log("IMP",r.channel.id,"agent_ivr","Inside on_hangup"),logger.log("IMP",r.channel.id,"agent_ivr","Internal Function [cleanup]"),r.channel.removeListener("ChannelHangupRequest",i),r.channel.removeListener("ChannelDestroyed",i),r.channel.removeListener("PlaybackFinished",a),r.channel.removeListener("ChannelDtmfReceived",l),mobile_counter=0,g=g&&null,logger.log("DEB",r.channel.id,"agent_ivr","State-Machine Update to ==> [Event.HANGUP]"),r.state_machine.change_state(Event.HANGUP)}logger.log("IMP",r.channel.id,"agent_ivr","Entering agent_ivr_state: agent_ivr_state"),r.channel.on("ChannelHangupRequest",i),r.channel.on("ChannelDestroyed",i),r.client.on("PlaybackFinished",a),r.channel.on("ChannelDtmfReceived",l),r.language="e",t(r.currentState),r.callcdrMode="22",r.callDirection="OUTGOING",r.callDirectionStatus="1"}}module.exports=AgentIncomingIvr;