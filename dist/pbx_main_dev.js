"use strict";var ari=require("ari-client"),util=require("util");const http=require("http");var Event=require("./events"),cfg=(require("dotenv").config({path:"../../.env.dev."+process.env.NODE_ENV}),require("../../pbx_config")),StateMachine=require("./fsm/state_machine.js"),UserDetailState=require("./pbx_user_detail"),UserIvrState=require("./pbx_ivr_detail"),AgentOutgoingState=require("./fsm/pbx_agent_outgoing.js"),AgentOutgoingParallelRingingState=require("./fsm/pbx_agent_outgoing_parallel_ringing.js"),AgentTransferState=require("./fsm/pbx_agent_transfer.js"),AgentWebTransferState=require("./pbx_agent_web_transfer"),AgentIvrState=require("./pbx_agent_ivr"),AgentIncomingState=require("./pbx_agent_incoming"),AgentC2CState=require("./pbx_agent_click2call.js"),AgentC2CS3rdPartytate=require("./pbx_agent_click2call_3rdparty.js"),VoicemailState=require("./pbx_voicemail"),EndPlayState=require("./pbx_end_play"),HangUpState=require("./fsm/pbx_hangup_state"),pbx_logger=require("./logger/pbx_logger.js"),dt=require("./common/datetime.js"),pbx_api=require("./api/pbx_api.js"),pbx_zmq_sms=require("./pbx_zmq_sms"),cdr=require("./cdr"),agent_processor=require("./agent_processor");const isUndefined=require("lodash")["isUndefined"];var lastCallTime,pline=new Object,logger=new pbx_logger,dateTime=new dt,api=new pbx_api,zmq_sms=new pbx_zmq_sms,agentProcessor=new agent_processor,PBX=function(i,e,t){this.client=i,this.channel=e,this.aBridge,this.language="en",this.queue_limit="0",this.queue_tried_counter=1,this.calling_number="",this.called_number="",this.agent_extention="",this.terminalID="ALL_BUSY",this.user_ivr_state="IVR_INIT",this.attemptCount=0,this.invalidCount=0,this.ivr_attempts=0,this.ivr_db_response=0,this.allocation_id=e.id+"_0",this.callJump=0,this.availableAgents=0,this.idealAgentFlag=0,this.idealAgentNumber=0,this.idealAgentID=2,this.idealAgentName="0",this.idealAgentStatus=0,this.idealAgentMasking=0,this.idealAgentGroup=0,this.agentWebrtcFlag=0,this.isAgentFreeNow=0,this.agentAssignedVN=0,this.agentAssignedVNAgentID="",this.agentAssignedVNAgentType=0,this.agentAssignedVNAgentStatus=0,this.webTransferEventType,this.aiBotEventType,this.aiBotMediaFile="na",this.recordingStoppedFlag=!1,this.initOnHangup="0",this.initOnHangupBy="none",this.firststickyAgentFlag="0",this.hardStickyAPIcallFlag=!1,this.stickyAgentFlag="0",this.customerStickyFlag="0",this.smerecording="0",this.smemasking="0",this.smevoicemail="0",this.smestatus="0",this.smeBillingStatus="0",this.agentEmail="0",this.smeID="",this.smeAlgorithm="",this.catDescAgent="0",this.urlAgentStatus=0,this.apiAgentArray=[],this.apiAgentParallelRingingArray=[],this.idealAgentReportFlag=11,this.agentCallResponseCode=16,this.agentCallResponseMsg="",this.TransferStartCallTime="",this.AgentStartCallTime="",this.AgentEndCallTime="",this.AgentCallDuration="",this.callSessionId="000",this.AgentStatus="1",this.agentCdrFlag="0",this.dbMusicOnHoldPrompt="",this.dbMusicOnHoldChannel="",this.dbMusicOnHoldPlayback,this.startMohClass="",this.callType=0,this.endCallDescription="",this.smeStickyAlgo="",this.callRouteReason="",this.yourCallRecordedFlagOnce=!1,this.endCallProvisionalFlag="0",this.endCallCdrProcessedFlag=!1,this.endCallNotificationFlag="0",this.endCallNotificationIsSent=!1,this.parallelRingingChannels="0",this.leadManagerPermissionFlag="0",this.incoming_permission_flag="0",this.outgoing_permission_flag="0",this.in_channels_capacity="0",this.out_channels_capacity="0",this.all_Sme_liveCalls_total="0",this.all_Sme_liveCalls_incoming="0",this.all_Sme_liveCalls_outgoing="0",this.self_Sme_liveCalls_total="0",this.self_Sme_liveCalls_incoming="0",this.self_Sme_liveCalls_outgoing="0",this.total_webrtc_channels="0",this.all_call_mode="na",this.timerAgentCall,this.timerDBconnect="60",this.objTransferDtmfStarOne,this.flagTransferDtmfStarOne="0",this.objReminderCallHoldToAgent,this.flagReminderCallHoldToAgent="0",this.timerState,this.noDtmfTransferCount=0,this.callTransferRestrictionCount=0,this.non_working_day_flag=!1,this.non_working_day_file,this.non_working_day_file_path,this.non_working_day_voicemail_flag=!1,this.non_working_day_transcode_status=!1,this.non_working_hour_flag=!1,this.non_working_hour_file,this.non_working_hour_file_path,this.non_working_hour_voicemail_flag=!1,this.non_working_hour_transcode_status=!1,this.jinglePlayPermission,this.jinglePlayFlag=!1,this.jinglePlayBack,this.agentRingingTime,this.objReminderAgentRingingTimeExpired,this.agentChannel,this.transfereeChannel,this.transferCallFlag="0",this.gcatId="",this.gcatDesc="",this.gparentCatId="",this.gchildrenStatus="",this.gvalidDtmf="",this.gmediaFile="",this.geventType="",this.gflowType="",this.gflowId="",this.gflowName="",this.gValidDtmfFlag="0",this.gNoDtmfFlag="0",this.globalPlayback,this.globalPlaybackFlag=!1,this.gflowQueueId="",this.gflowQueueName="",this.gexpected_dtmf="",this.ivrCallFlowName="",this.ivrFlow_dtmf="",this.ivrFlow_ivr_id="",this.ivrFlow_end_of_media_flag="",this.ivrFlow_retry="",this.ivrFlow_child_dtmf_wait=!1,this.ivtFlow_dtmf_wait_time=0,this.ivtFlow_expected_dtmf="",this.ivrFlow_eventType="",this.ivtFlow_cat_desc="",this.userEnteredDtmf="",this.allIvrDtmf="",this.ignorePlaybackFinished_flag=!1,this.setTimeout_playback_finished_id,this.setTimeout_funIvrHandler_id,this.ivrFlowInvalid_flag=!1,this.ivrFlowInvalid_ivr_id="",this.ivrFlowInvalid_redirect_event_type="",this.ivrFlowInvalid_redirect_queue_id="",this.ivrFlowInvalid_redirect_queue_name="",this.ivrFlowInvalid_redirect_ivr_id="",this.ivrFlowInvalid_redirect_dtmf="",this.ivrFlowInvalid_redirect_retry="",this.ivrFlowInvalid_redirect_child_dtmf_wait=!1,this.ivrFlowInvalid_redirect_end_of_media_flag="",this.ivrFlowInvalid_redirect_directory_path="",this.ivrFlowInvalid_redirect_dtmf_wait_time=0,this.ivrFlowInvalid_redirect_expected_dtmf="",this.invalidStatePlayMediaPath="",this.ivtFlowInvalid_expected_dtmf="",this.ivrFlowInvalid_directory_path="",this.ivrFlowInvalid_retry="",this.ivrFlowInvalid_retry_counting=1,this.ivrFlowNoInput_flag=!1,this.ivrFlowNoInput_ivr_id="",this.ivrFlowNoInput_redirect_event_type="",this.ivrFlowNoInput_redirect_queue_id="",this.ivrFlowNoInput_redirect_queue_name="",this.ivrFlowNoInput_redirect_ivr_id="",this.ivrFlowNoInput_redirect_dtmf="",this.ivrFlowNoInput_redirect_retry="",this.ivrFlowNoInput_redirect_child_dtmf_wait=!1,this.ivrFlowNoInput_redirect_end_of_media_flag="",this.ivrFlowNoInput_redirect_directory_path="",this.ivrFlowNoInput_redirect_dtmf_wait_time=0,this.ivrFlowNoInput_redirect_expected_dtmf="",this.noInputStatePlayMediaPath="",this.ivtFlowNoInput_expected_dtmf="",this.ivrFlowNoInput_directory_path="",this.ivrFlowNoInput_retry="",this.ivrFlowNoInput_retry_counting=1,this.ivrMediaPlayArray=[],this.webTransferType="",this.webTransferTo="",this.transAgentMobile="",this.transAgentId="",this.transAgentGroup="",this.transAgenStatus="",this.transAgenSticky="",this.transAgenStickyDays="",this.transAgenMasking="",this.transAgenScore="",this.transAgenEmailId="",this.transAgenAnswerStatus="1",this.transDtmf="",this.transHoldFlag="0",this.transHoldMusic="0",this.blackListFlag="0",this.callerId="",this.finalDTMF="",this.orignalAgentHoldMusic="0",this.orignalAgentPlayback="0",this.transLegFlag="0",this.transType="0",this.origAgentSessionID="",this.transfreeAgentSessionID="",this.whichtransLeg="ORIGNAL_AGENT",this.transferAgentArray=[],this.CDRtransAgentMobile="",this.CDRtransAgentId="",this.CDRtransAgentGroup="",this.CDRtransAgentSessionId="",this.CDRtransAgenStatus="",this.CDRtransAgenStartTime="",this.CDRtransidealAgentFlag="",this.CDRdisconnectFlag="NA",this.CDRAnswerFlag="NA",this.dialedLeg,this.dialedAnsweredLeg,this.dialedLegInit=!1,this.dialedLegOriginate=!1,this.dialedLegDinit=!1,this.dialedLegState="init",this.dialedAgentWriteCdrFlag=!1,this.mainLeg,this.mainLegDinit=!1,this.mainLegInit=!1,this.mainLegState="init",this.mainEndCallWriteCdrFlag=!1,this.transferLeg,this.transferLegDinit=!1,this.transferLegInit=!1,this.transferLegOriginate=!1,this.transferLegState="init",this.transAgentWriteCdrFlag=!1,this.transferClearState="nothing",this.AgentStartTime="",this.AgentEndTime="",this.AgentConnectedStartTime="",this.AgentConnectedEndTime="",this.AgentConnectedDuration="0",this.AgentRingingStartTime="",this.AgentRingingEndTime="",this.AgentRingingDuration="0",this.IvrEndTime="",this.IvrCallDuration="0",this.triedAgentList=[],this.triedAgentListV2=[],this.packId="0",this.packMinutes="0",this.packNoOfCalls="0",this.packUnlimitedCallsFlag="0",this.packValidayDaysLeft="0",this.packType="0",this.planTypeDetail="0",this.assigned_agent_id="",this.assigned_agent_name="",this.assigned_agent_mobile="",this.assigned_agent_status_int="",this.assigned_agent_email="",this.assigned_agent_sticky_type="",this.assigned_agent_group="",this.assigned_agent_group_id="",this.assigned_agent_webrtc_flag="",this.assigned_agent_webrtc_registered_duration="",this.assigned_agent_webrtc_registered_flag="",this.TransferAgentStartTime="",this.TransferAgentEndTime="",this.TransferAgentConnectedStartTime="",this.TransferAgentConnectedEndTime="",this.TransferAgentConnectedDuration="0",this.TransferAgentRingingStartTime="",this.TransferAgentRingingEndTime="",this.TransferAgentRingingDuration="0",this.CustomerRingingStartTime="",this.CustomerConnectedStartTime="",this.CustomerRingingEndTime="",this.CustomerRingingDuration="",this.customerReportFlag=11,this.customerStatus="1",this.customerCallResponseCode="16",this.customerStartCallTime="",this.customerEndCallTime="",this.customerCallDuration="",this.customerNumber="",this.customerCallRouteReason="",this.writeCdrFlag=!1,this.callProfileObj,this.callDirection,this.agentDialed,this.callDirectionStatus,this.callcdrMode,this.callModeNew="4",this.callDuration,this.callstartDateTime,this.callstartDateTimeV2,this.callstartDateTimeCRM,this.callendDateTime,this.callendDateTimeV2,this.callStatusCRM="notpatched",this.s3RecordedFile,this.s3RecordedFileWav,this.s3uploadedUrl,this.callRecordedFile,this.callRecordedFileRaw,this.callRecordingStatus,this.callchannelNo,this.callHlr,this.callinsertDateTime,this.calllongcode,this.callmasterShortcode,this.callpatchedAgentId,this.callpatchedAgentName,this.callpatchedAgentGroup="0",this.callshortcodeMapping,this.callsmeIdentifier,this.voicemailRecordingFile,this.voicemailRecordingFileRaw,this.voicemailRecordingStatus,this.callgroupid,this.callcdrFlag,this.callanswerFlag,this.callBridgeId,this.callBridge,this.callfinalStatus="1",this.calldisconnectedBy="me",this.callrecording,this.adRecordingFileId="0",this.callvoicemailrec="0",this.callvoicemailstate="PLAY_WELCOME",this.voicemailTimer="NA",this.voicemailTimerCounter="0",this.playback="0",this.address_book_name="0",this.address_book_id="0",this.callBlackListCustomerFlag="0",this.ivrFailedCallReason="na",this.liveEventCallType="Incoming",this.agentC2CtriedCounter=1,this.outVirtualNo,this.aiBotCallType="INBOND",this.timeToMakeCallNow=!1,this.queue_name,this.queue_id,this.callagentincomingstate="AGENT_WELCOME",this.customer_number="0",this.callMode,this.callType,this.c2cMode,this.gcdrStr,this.gAgentCdrStr,this.gliveEvents="0",this.callInfo="incoming",this.activeEvents="0",this.accountSid="0",this.crmPartner="0",this.smsPartner="0",this.adCallResponse="0",this.triedAgentArray=[],this.setup_state_machine=function(){var i=new HangUpState(this),e=new UserDetailState(this),t=new UserIvrState(this),n=new AgentOutgoingState(this),a=new AgentOutgoingParallelRingingState(this),s=new AgentTransferState(this),l=new AgentWebTransferState(this),r=new AgentIvrState(this),g=new AgentIncomingState(this),d=new AgentC2CState(this),o=new AgentC2CS3rdPartytate(this),c=new VoicemailState(this),h=new EndPlayState(this);this.state_machine=new StateMachine(this),this.state_machine.add_transition(e,Event.SME_RECEIVED,t),this.state_machine.add_transition(t,Event.VOICEMAIL,c),this.state_machine.add_transition(e,Event.IVR_RECEIVED,n),this.state_machine.add_transition(e,Event.AGENT_INCOMING,r),this.state_machine.add_transition(e,Event.AGENT_C2C,d),this.state_machine.add_transition(e,Event.AGENT_C2C_3RDPARTY,o),this.state_machine.add_transition(e,Event.HANGUP,i),this.state_machine.add_transition(e,Event.WEB_TRANSFER,l),this.state_machine.add_transition(t,Event.IVR_RECEIVED,n),this.state_machine.add_transition(n,Event.VOICEMAIL,c),this.state_machine.add_transition(t,Event.HANGUP,i),this.state_machine.add_transition(t,Event.IVR_RECEIVED_PR,a),this.state_machine.add_transition(n,Event.HANGUP,i),this.state_machine.add_transition(n,Event.AGENT_CALL,n),this.state_machine.add_transition(i,Event.HANGUP,n),this.state_machine.add_transition(i,Event.HANGUP,t),this.state_machine.add_transition(a,Event.HANGUP,i),this.state_machine.add_transition(a,Event.VOICEMAIL,c),this.state_machine.add_transition(n,Event.VOICEMAIL,c),this.state_machine.add_transition(n,Event.TRANSFER,s),this.state_machine.add_transition(s,Event.TRANSFER,s),this.state_machine.add_transition(s,Event.AGENT_CALL,n),this.state_machine.add_transition(s,Event.HANGUP,i),this.state_machine.add_transition(n,Event.WEB_TRANSFER,l),this.state_machine.add_transition(l,Event.WEB_TRANSFER,l),this.state_machine.add_transition(l,Event.AGENT_CALL,n),this.state_machine.add_transition(l,Event.HANGUP,i),this.state_machine.add_transition(c,Event.HANGUP,i),this.state_machine.add_transition(r,Event.HANGUP,i),this.state_machine.add_transition(r,Event.MAKE_CALL,g),this.state_machine.add_transition(g,Event.END_PLAY,h),this.state_machine.add_transition(g,Event.HANGUP,i),this.state_machine.add_transition(d,Event.AGENT_INCOMING,r),this.state_machine.add_transition(d,Event.AGENT_C2C,d),this.state_machine.add_transition(o,Event.AGENT_C2C_3RDPARTY,o),this.state_machine.add_transition(d,Event.HANGUP,i),this.state_machine.add_transition(o,Event.HANGUP,o),this.state_machine.add_transition(h,Event.HANGUP,i),this.state_machine.add_transition(i,Event.HANGUP,i),this.state_machine.start(e)};this.setup_state_machine()};function clientLoaded(i,a){var o=new Object,e=(logger.log("DEB",0,"main","Client Loaded"),logger.log("DEB",0,"main","ZMQ SMS binding Init...: "+zmq_sms),zmq_sms.bind(),logger.log("DEB",0,"main","ZMQ SMS bind Successfully"),cfg.cdr.path+"/"+cfg.cdr.title),c=(logger.log("DEB",0,"main","Debug: Initializing CDRs ("+e+")"),new cdr(e));function h(i,e){var t=o[i.id];logger.log("IMP",i.id,"main","Internal Function [funcPushSms]"),agentProcessor.funEndCallSMSexternal(t)}function m(i,e){var t=o[i.id];logger.log("IMP",i.id,"main","Internal Function [funcPushSmsInternal] "+e),agentProcessor.funEndCallSMS(t)}function _(i){var e=o[i.id];logger.log("IMP",i.id,"main","Internal Function [clearLiveCall]"),setTimeout(function(){agentProcessor.removeLiveCall(e)},1e3)}a.on("StasisStart",function(i,t){logger.log("IMP",t.id,"main","ON Event [stasisStart]");var e="AGENT_CH"===i.args[0];{var n;logger.log("DEB",t.id,"main","Agent call, args: "+i.args),"SNOOPING_FOR_TRANSFER"==i.args||"SNOOPING_FOR_RINGING"==i.args||"SNOOPING_FOR_TRY_AGAIN_LATER"==i.args||"SNOOPING_FOR_AGENT_15SECONDS"==i.args||"SNOOPING_NOTIFY_AGENT_CUST_CALL_ON_HOLD"==i.args||"SNOOPING_NOTIFY_AGENT_CUST_CALL_UNHOLD"==i.args?(o[t.id],logger.log("DEB",t.id,"main","Going to play media["+n+"]"),n="","SNOOPING_FOR_TRANSFER"==i.args?n="sound:"+cfg.media.dir+"/"+cfg.media.call_transfer+"-e":"SNOOPING_FOR_RINGING"==i.args?(logger.log("DEB",t.id,"main","play ringing.........................................."),n="sound:"+cfg.media.dir+"/"+cfg.media.call_hold_music_35sec+"-e"):"SNOOPING_FOR_TRY_AGAIN_LATER"==i.args?(logger.log("DEB",t.id,"main","play try again later.........................................."),n="sound:"+cfg.media.dir+"/"+cfg.outgoing.not_input_add_extention+"-e"):"SNOOPING_FOR_AGENT_15SECONDS"==i.args?(logger.log("DEB",t.id,"main","play light hold to agent also.........................................."),n="sound:"+cfg.media.dir+"/"+cfg.media.call_hold_music_35sec+"-e"):"SNOOPING_NOTIFY_AGENT_CUST_CALL_ON_HOLD"==i.args?(logger.log("DEB",t.id,"main","play light hold to agent also.........................................."),n="sound:"+cfg.media.dir+"/"+cfg.outgoing.customer_on_hold_now+"-e"):"SNOOPING_NOTIFY_AGENT_CUST_CALL_UNHOLD"==i.args&&(logger.log("DEB",t.id,"main","play light hold to agent also.........................................."),n="sound:"+cfg.media.dir+"/"+cfg.outgoing.customer_un_hold_now+"-e"),logger.log("DEB",t.id,"main","Going to play media["+n+"]"),t.play({media:n},null,function(i,e){i?logger.log("ERR",t.id,"ivr_detail","...In Playback Handler:"+i):logger.log("DEB",t.id,"ivr_detail","...playing fine.....:")})):e?logger.log("DEB",t.id,"main","Not proceding with this stasisStart becasue its agent call"):(o[t.id]=new PBX(a,t),o[t.id].mainLeg=t,o[t.id].mainLegInit=!0,o[t.id].mainLegState="connected",logger.log("IMP",t.id,"main","Internal Function [st_INCOMING_INVITE]"),logger.log("DEB",t.id,"main","Channel: "+t.id),logger.log("DEB",t.id,"main","Calling Number: "+o[t.id].channel.caller.number),logger.log("DEB",t.id,"main","Called Number: "+o[t.id].channel.dialplan.exten),logger.log("DEB",t.id,"main","Current State: "+o[t.id].channel.currentState),dateTime.getDateTimeString2V(),o[t.id].callMode="IVR_IN",lastCallTime=dateTime.getAgentDateTime(),logger.log("DEB",t.id,"main","Uniqe Session ID created: "+o[t.id].callSessionId),o[t.id].callDirection="INCOMING",o[t.id].callDirectionStatus="1",o[t.id].callRecordedFile="0",o[t.id].callRecordedFileRaw="0",o[t.id].callRecordingStatus="0",logger.log("DEB",t.id,"main","1: "+o[t.id].callSessionId),o[t.id].callcdrMode="1",o[t.id].callchannelNo=t.id.substring(0,7),o[t.id].callHlr="DH-17",o[t.id].called_number=o[t.id].channel.dialplan.exten,o[t.id].calling_number=o[t.id].channel.caller.number,o[t.id].calllongcode="0",o[t.id].callmasterShortcode="70705",o[t.id].callshortcodeMapping="0",o[t.id].voicemailRecordingFile="0",o[t.id].voicemailRecordingFileRaw="0",o[t.id].voicemailRecordingStatus="0",o[t.id].callgroupid="1",o[t.id].callcdrFlag="false",o[t.id].callanswerFlag="2",o[t.id].callfinalStatus="1",o[t.id].calldisconnectedBy="none",o[t.id].callpatchedAgentGroup="none",o[t.id].callpatchedAgentId="none",o[t.id].callrecording="none",logger.log("DEB",t.id,"main","2: "+o[t.id].callSessionId),o[t.id].callstartDateTime=dateTime.getcallDateTime(),o[t.id].callstartDateTimeV2=dateTime.getcallDateTime(),o[t.id].callstartDateTimeCRM=dateTime.getcallDateTimeCRM(),o[t.id].CustomerRingingStartTime=dateTime.getAgentDateTime(),o[t.id].CustomerConnectedStartTime=dateTime.getAgentDateTime(),o[t.id].CustomerRingingEndTime=dateTime.getAgentDateTime(),o[t.id].CustomerRingingDuration=dateTime.calculateDuration(o[t.id].CustomerRingingStartTime,o[t.id].CustomerRingingEndTime),logger.log("DEB",t.id,"main","CustomerRingingDuration("+o[t.id].CustomerRingingDuration+")"),logger.log("DEB",t.id,"main","3: "+o[t.id].callSessionId))}}),a.on("StasisEnd",function(i,e){if(logger.log("IMP",e.id,"main","ON Event [stasisEnd]"),logger.log("DEB",e.id,"main","Ended Stasis for Channel:"+e.id),o[e.id]){logger.log("DEB",e.id,"main","This Call:"+o[e.id].channel.caller.number),logger.log("DEB",e.id,"main","Call Ended in state:"+o[e.id].currentState),logger.log("DEB",e.id,"main","calldisconnectedBy:"+o[e.id].calldisconnectedBy),o[e.id].mainLegDinit=!0,(o[e.id].CustomerConnectedDuration<="0"||isNaN(o[e.id].CustomerConnectedDuration))&&(logger.log("DEB",e.id,"main","empty CustomerConnectedDuration:"+o[e.id].CustomerConnectedDuration),o[e.id].CustomerConnectedEndTime=dateTime.getAgentDateTime(),o[e.id].CustomerConnectedDuration=dateTime.calculateDuration(o[e.id].CustomerConnectedStartTime,o[e.id].CustomerConnectedEndTime),logger.log("DEB",e.id,"main","build complete for CustomerConnectedDuration("+o[e.id].CustomerConnectedDuration+")")),"none"===o[e.id].calldisconnectedBy&&(logger.log("DEB",e.id,"main","calldisconnectedBy("+o[e.id].calldisconnectedBy+")"),o[e.id].calldisconnectedBy="user_disconnect"),"none"===o[e.id].initOnHangupBy&&(logger.log("DEB",e.id,"main","initOnHangupBy(none) => (customer)"),o[e.id].initOnHangupBy="customer");var t=o[e.id],n=(t.transHoldFlag="0","1"==o[e.id].isAgentFreeNow&&(logger.log("DEB",e.id,"main","calling makeAgentFree to mark the tried agent idle"),o[e.id].isAgentFreeNow="0",t=o[e.id],agentProcessor.freeAgent(t)),o[e.id].agentCdrFlag,setTimeout(_,1100,e),"WRINGG_APP"!=o[e.id].callMode&&"WRINGG_WEB"!=o[e.id].callMode&&"CRM_APP"!=o[e.id].callMode&&"CRM_WEB"!=o[e.id].callMode&&(n=o[e.id].gliveEvents.includes("evt_completed"),logger.log("DEB",e.id,"main","returnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn"+n),!0===n?(o[e.id].activeEvents="evt_completed",logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") subscribed for evt_completed"),logger.log("DEB",e.id,"main","initiate live event................................................."),logger.log("DEB",e.id,"main","Init setTimeout (funcNotifyAutodialer)"),setTimeout(agentProcessor.funcNotifyCrmIncomingCalls,1e3,t,"evt_completed")):logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") not subscribed for evt_completed from("+o[e.id].gliveEvents+")"),n=o[e.id].gliveEvents.includes("evt_endcall"),logger.log("DEB",e.id,"main","returnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnn"+n),!0===n?(o[e.id].activeEvents="evt_endcall",logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") subscribed for evt_endcall"),logger.log("DEB",e.id,"main","initiate live event................................................."),logger.log("DEB",e.id,"main","Init setTimeout (funcNotifyAutodialer)"),setTimeout(agentProcessor.funcNotifyCrmIncomingCalls,1e3,t,"evt_endcall")):logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") not subscribed for evt_completed from("+o[e.id].gliveEvents+")")),o[e.id].gliveEvents.includes("evt_sendsms")),n=(logger.log("DEB",e.id,"main","evt_sendsms event is marked "+n),!0===n?(o[e.id].activeEvents="evt_sendsms",logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") subscribed for evt_sendsms"),logger.log("DEB",e.id,"main","initiate live event................................................."),logger.log("DEB",e.id,"main","Init setTimeout (funcNotifyAutodialer)"),setTimeout(h,1e3,e,"evt_sendsms")):logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") not subscribed for evt_completed from("+o[e.id].gliveEvents+")"),o[e.id].gliveEvents.includes("evt_sendsms_komm"));if(logger.log("DEB",e.id,"main","evt_sendsms_komm event is marked "+n),!0===n&&"INCOMING"==o[e.id].callDirection&&(o[e.id].activeEvents="evt_sendsms_komm",logger.log("DEB",e.id,"main","SME("+o[e.id].smeID+") subscribed for evt_sendsms_komm"),setTimeout(m,2e3,e,"evt_sendsms_komm")),logger.log("DEB",e.id,"main","dialedLegInit("+o[e.id].dialedLegInit+") & dialedLegDinit("+o[e.id].dialedLegDinit+")"),"connected"!=o[e.id].dialedLegState&&"originating"!=o[e.id].dialedLegState&&"ringing"!=o[e.id].dialedLegState||0!=o[e.id].dialedLegDinit||(logger.log("DEB",e.id,"main","dialedLeg.hangup from main...."),o[e.id].dialedLeg.hangup(function(i){i?logger.log("ERR",e.id,"main","Error while hangup agent leg."+i):logger.log("DEB",e.id,"main","success while hangup agent leg.")})),"connected"!=o[e.id].transferLegState&&"originating"!=o[e.id].transferLegState&&"ringing"!=o[e.id].transferLegState||0!=o[e.id].transferLegDinit||(logger.log("DEB",e.id,"main","transferLeg.hangup from main...."),o[e.id].transferLeg.hangup(function(i){i?logger.log("ERR",e.id,"main","Error while hangup agent leg."+i):logger.log("DEB",e.id,"main","success while hangup agent leg.")})),agentProcessor.setEndCallCdr(t,c),logger.log("DEB",e.id,"main","check callDirection("+o[e.id].callDirection+"), endCallNotificationFlag("+o[e.id].endCallNotificationFlag+"), endCallNotificationIsSent("+o[e.id].endCallNotificationIsSent+")"),"OUTGOING"==o[e.id].callDirection&&"1"==o[e.id].endCallNotificationFlag&&0==o[e.id].endCallNotificationIsSent?(logger.log("DEB",e.id,"main","sending funEndCallNotification for APP outgoing case"),o[e.id].endCallNotificationIsSent=!0,agentProcessor.funEndCallNotification(t)):logger.log("DEB",e.id,"main","don't sending funEndCallNotification."),logger.log("DEB",e.id,"main","parallelRingingChannels("+o[e.id].parallelRingingChannels+"), length("+o[e.id].apiAgentParallelRingingArray.length+")"),"0"<o[e.id].parallelRingingChannels&&0<o[e.id].apiAgentParallelRingingArray.length){logger.log("DEB",e.id,"main","lets clear parallel ringing agents.");for(var a=0;a<o[e.id].apiAgentParallelRingingArray.length;a++){var s=o[e.id].apiAgentParallelRingingArray[a],l=(logger.log("DEB",e.id,"main","("+s.dialed.id+"), clear the answered leg.."),s.dialed.hangup(function(i){i?logger.log("ERR",e.id,"main"," Error while hanging up channel("+s.dialed+"), err: "+i):logger.log("DEB",e.id,"main"," successfully hangup channel("+s.dialed+")")}),logger.log("DEB",e.id,"main","######################making free to ("+s.AgentId+")#######################################"),agentProcessor.freeAgentPR(o[e.id],s.AgentId,s.AgentNumber,s.AgentGroup),agentProcessor.removeLiveCallPR(o[e.id],s.dialed.id),"0"),r="0",g=(l=0!=s.RingingStartTime?(r=dateTime.getAgentDateTime(),dateTime.calculateDuration(s.RingingStartTime,r)):"0",s.RingingEndTime=r,s.Ringingduration=l,dateTime.getAgentDateTime()),d=dateTime.calculateDuration(o[e.id].AgentStartCallTime,g);logger.log("DEB",e.id,"main","RingingStartTime ("+s.RingingStartTime+")"),logger.log("DEB",e.id,"main","aRingingEndTime ("+r+")"),logger.log("DEB",e.id,"main","aRingingDuration ("+l+")"),logger.log("DEB",e.id,"main","aAgentEndCallTime ("+g+")"),logger.log("DEB",e.id,"main","aAgentCallDuration ("+d+")"),"0"==s.CdrCreatedFlag&&"0"==s.isCallAnswered&&(s.CdrCreatedFlag="1",agentProcessor.logAgentCdrPR(o[e.id],o[e.id].idealAgentReportFlag,o[e.id].smeID,s.AgentId,"1",o[e.id].agentCallResponseCode,o[e.id].AgentStartCallTime,g,d,s.AgentGroup,"0",o[e.id].callSessionId,o[e.id].callMode,o[e.id].callInfo,l,"0","parallel ringing"))}}else logger.log("DEB",e.id,"main","no parallel ringing agents.");logger.log("IMP",e.id,"main","[CALLS BALANCE DEDUCTION]"),"INCOMING"==o[e.id].callDirection&&"1"==o[e.id].callanswerFlag?"minute"==o[e.id].planTypeDetail||"call"==o[e.id].planTypeDetail?(logger.log("DEB",e.id,"main","Its INCOMING Answered Call and PlanType("+o[e.id].planTypeDetail+"), {sending balance deduction}"),agentProcessor.deductCallBalance(o[e.id])):"unlimited"==o[e.id].planTypeDetail?logger.log("DEB",e.id,"main","Its INCOMING Answered Call and PlanType("+o[e.id].planTypeDetail+"), {no balance deduction}"):logger.log("ERR",e.id,"main","Its INCOMING Answered Call and PlanType("+o[e.id].planTypeDetail+"), {invalid pack}"):"OUTGOING"==o[e.id].callDirection&&"2"==o[e.id].callanswerFlag&&("minute"==o[e.id].planTypeDetail||"call"==o[e.id].planTypeDetail?(agentProcessor.deductCallBalance(o[e.id]),logger.log("DEB",e.id,"main","Its OUTGOING Answered Call and PlanType("+o[e.id].planTypeDetail+"), {sending balance deduction}")):"unlimited"==o[e.id].planTypeDetail?logger.log("DEB",e.id,"main","Its OUTGOING Answered Call and PlanType("+o[e.id].planTypeDetail+"), {no balance deduction}"):logger.log("ERR",e.id,"main","Its OUTGOING Answered Call and PlanType("+o[e.id].planTypeDetail+"), {invalid pack}"))}}),a.start(cfg.asterisk.stasisApp)}logger.init(),logger.log("DEB",0,"main","Init......");var asteriskAddress="http://"+cfg.asterisk.ip+":"+cfg.asterisk.port;logger.log("DEB",0,"main",""+asteriskAddress),ari.connect(asteriskAddress,cfg.asterisk.user,cfg.asterisk.password,clientLoaded),logger.log("DEB",0,"main","Asterisk Initiated......."),process.on("uncaughtException",function(i){logger.log("ERR",0,"main","Caught exception: "+i),logger.log("ERR",0,"main","Caught exception error message: "+(new Date).toUTCString()+" uncaughtException:",i.message),logger.log("ERR",0,"main","Caught exception stack: "+i.stack)});