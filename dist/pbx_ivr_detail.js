var Event=require("./events"),cfg=require("../../pbx_config"),pbx_db=require("./pbx_db"),pbx_api=require("./api/pbx_api"),dt=require("./common/datetime"),pbx_logger=require("./logger/pbx_logger"),express=require("express");const cos=require("prelude-ls")["cos"],util=require("util"),fs=require("fs"),http=require("https"),request=require("request");var logger=new pbx_logger,dateTime=new dt,api=new pbx_api;function GetIvrDetail(v){this.state_name="user_ivr_state",this.enter=function(){new pbx_db;function l(e,i,l,a,t){logger.log("IMP",v.channel.id,"ivr_detail","Inside funInvalidHandler"),logger.log("IMP",v.channel.id,"ivr_detail","timer expired but no dtmf input.."),"INVALID_INPUT"==v.user_ivr_state&&(v.user_ivr_state="NO_INPUT",v.gmediaFile=v.ivrFlowNoInput_directory_path,v.ivrFlowNoInput_retry_counting=v.ivrFlowNoInput_retry_counting+1,v.noInputStatePlayMediaPath="sound:"+v.gmediaFile,r(v.currentState))}function a(e,i,l,a,t){logger.log("IMP",v.channel.id,"ivr_detail","Inside funIvrHandler"),v.ivrFlowInvalid_flag=!1;1==v.timeToMakeCallNow?logger.log("ERR",v.channel.id,"ivr_detail","timeToMakeCallNow is true, so ignore funIvrHandler"):(logger.log("ERR",v.channel.id,"ivr_detail","timeToMakeCallNow is false, so call funIvrHandler"),api.getIVRFlow(v.channel.id,v.smeID,i,a,l,t,v.callSessionId,function(e,i,l){logger.log("DEB",v.channel.id,"ivr_detail","NEW - flow_name: "+l.data.ivrFlow[0].flow_name),!e&&l.data?(logger.log("DEB",v.channel.id,"ivr_detail","IVR API Response Success"),v.geventType=l.data.ivrFlow[0].event_type,v.ivrFlow_ivr_id=l.data.ivrFlow[0].id,l.data.ivrFlow[0].directory_path?v.gmediaFile=l.data.ivrFlow[0].directory_path.replace(".wav",""):v.gmediaFile=l.data.ivrFlow[0].directory_path,v.gflowQueueId=l.data.ivrFlow[0].queue_id,v.gflowQueueName=l.data.ivrFlow[0].queue_name,v.gflowDtmf=l.data.ivrFlow[0].dtmf,v.ivrFlow_child_dtmf_wait=l.data.ivrFlow[0].child_dtmf_wait,v.ivtFlow_dtmf_wait_time=3,v.ivtFlow_expected_dtmf=l.data.ivrFlow[0].expected_dtmf,v.ivtFlow_cat_desc=l.data.ivrFlow[0].cat_desc,logger.log("DEB",v.channel.id,"ivr_detail","geventType: "+v.geventType),logger.log("DEB",v.channel.id,"ivr_detail","ivrFlow_ivr_id: "+v.ivrFlow_ivr_id),logger.log("DEB",v.channel.id,"ivr_detail","gmediaFile: "+v.gmediaFile),logger.log("DEB",v.channel.id,"ivr_detail","gflowQueueId: "+v.gflowQueueId),logger.log("DEB",v.channel.id,"ivr_detail","gflowQueueName: "+v.gflowQueueName),logger.log("DEB",v.channel.id,"ivr_detail","child_dtmf_wait: "+v.ivrFlow_child_dtmf_wait),logger.log("DEB",v.channel.id,"ivr_detail","dtmf_wait_time: "+v.ivtFlow_dtmf_wait_time),logger.log("DEB",v.channel.id,"ivr_detail","expected_dtmf: "+v.ivtFlow_expected_dtmf),logger.log("DEB",v.channel.id,"ivr_detail","cat_desc: "+v.ivtFlow_cat_desc),v.user_ivr_state="IVR_POST_INIT",l.data.invalid&&l.data.invalid[0]&&(logger.log("DEB",v.channel.id,"ivr_detail","Invalid Flow available: "),l.data.invalid[0].invalid_redirect[0])&&(logger.log("DEB",v.channel.id,"ivr_detail","Invalid-redirect Flow available: "),l.data.invalid[0].directory_path)&&l.data.invalid[0].invalid_redirect[0].directory_path&&(logger.log("DEB",v.channel.id,"ivr_detail","invalid & redirect ok, so setting ivrFlowInvalid_flag: true"),v.ivrFlowInvalid_flag=!0,v.ivrFlowInvalid_directory_path=l.data.invalid[0].directory_path.replace(/\b(.mp3|.wav)\b/gi,""),v.ivrFlowInvalid_retry=l.data.invalid[0].retry,logger.log("DEB",v.channel.id,"ivr_detail","Invalid Flow cat_desc("+l.data.invalid[0].cat_desc+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Flow title("+l.data.invalid[0].title+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Flow event_type("+l.data.invalid[0].event_type+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Flow directory_path("+v.ivrFlowInvalid_directory_path+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Flow retry("+v.ivrFlowInvalid_retry+")"),v.ivrFlowInvalid_redirect_directory_path=l.data.invalid[0].invalid_redirect[0].directory_path.replace(/\b(.mp3|.wav)\b/gi,""),v.ivrFlowInvalid_redirect_retry=l.data.invalid[0].invalid_redirect[0].retry,v.ivrFlowInvalid_redirect_queue_id=l.data.invalid[0].invalid_redirect[0].queue_id,v.ivrFlowInvalid_redirect_queue_name=l.data.invalid[0].invalid_redirect[0].queue_name,v.ivrFlowInvalid_redirect_ivr_id=l.data.invalid[0].invalid_redirect[0].id,v.ivrFlowInvalid_redirect_dtmf=l.data.invalid[0].invalid_redirect[0].dtmf,v.ivrFlowInvalid_redirect_child_dtmf_wait=l.data.invalid[0].invalid_redirect[0].child_dtmf_wait,v.ivrFlowInvalid_redirect_dtmf_wait_time=l.data.invalid[0].invalid_redirect[0].dtmf_wait_time,v.ivrFlowInvalid_redirect_expected_dtmf=l.data.invalid[0].invalid_redirect[0].expected_dtmf,v.ivrFlowInvalid_redirect_event_type=l.data.invalid[0].invalid_redirect[0].event_type,logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect directory_path("+v.ivrFlowInvalid_redirect_directory_path+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect retry("+v.ivrFlowInvalid_redirect_retry+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect queue_id("+v.ivrFlowInvalid_redirect_queue_id+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect queue_name("+v.ivrFlowInvalid_redirect_queue_name+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect ivr_id("+v.ivrFlowInvalid_redirect_ivr_id+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect dtmf("+v.ivrFlowInvalid_redirect_dtmf+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect child_dtmf_wait("+v.ivrFlowInvalid_redirect_child_dtmf_wait+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect dtmf_wait_time("+v.ivrFlowInvalid_redirect_dtmf_wait_time+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect expected_dtmf("+v.ivrFlowInvalid_redirect_expected_dtmf+")"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid Redirect event_type("+v.ivrFlowInvalid_redirect_event_type+")")),l.data.noinput&&l.data.noinput[0]?(logger.log("DEB",v.channel.id,"ivr_detail","noinput Flow available: "),l.data.noinput[0].noinput_redirect&&l.data.noinput[0].noinput_redirect[0]?(logger.log("DEB",v.channel.id,"ivr_detail","noinput-redirect Flow available: "),l.data.noinput[0].directory_path&&l.data.noinput[0].noinput_redirect[0].directory_path&&(logger.log("DEB",v.channel.id,"ivr_detail","noinput & redirect ok, so setting ivrFlowNoInput_flag: true"),v.ivrFlowNoInput_flag=!0,v.ivrFlowNoInput_directory_path=l.data.noinput[0].directory_path.replace(/\b(.mp3|.wav)\b/gi,""),v.ivrFlowNoInput_retry=l.data.noinput[0].retry,logger.log("DEB",v.channel.id,"ivr_detail","NoInput Flow cat_desc("+l.data.noinput[0].cat_desc+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Flow title("+l.data.noinput[0].title+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Flow event_type("+l.data.noinput[0].event_type+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Flow directory_path("+v.ivrFlowNoInput_directory_path+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Flow retry("+v.ivrFlowNoInput_retry+")"),v.ivrFlowNoInput_redirect_directory_path=l.data.noinput[0].noinput_redirect[0].directory_path.replace(/\b(.mp3|.wav)\b/gi,""),v.ivrFlowNoInput_redirect_retry=l.data.noinput[0].noinput_redirect[0].retry,v.ivrFlowNoInput_redirect_queue_id=l.data.noinput[0].noinput_redirect[0].queue_id,v.ivrFlowNoInput_redirect_queue_name=l.data.noinput[0].noinput_redirect[0].queue_name,v.ivrFlowNoInput_redirect_ivr_id=l.data.noinput[0].noinput_redirect[0].id,v.ivrFlowNoInput_redirect_dtmf=l.data.noinput[0].noinput_redirect[0].dtmf,v.ivrFlowNoInput_redirect_child_dtmf_wait=l.data.noinput[0].noinput_redirect[0].child_dtmf_wait,v.ivrFlowNoInput_redirect_dtmf_wait_time=l.data.noinput[0].noinput_redirect[0].dtmf_wait_time,v.ivrFlowNoInput_redirect_expected_dtmf=l.data.noinput[0].noinput_redirect[0].expected_dtmf,v.ivrFlowNoInput_redirect_event_type=l.data.noinput[0].noinput_redirect[0].event_type,logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect directory_path("+v.ivrFlowNoInput_redirect_directory_path+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect retry("+v.ivrFlowNoInput_redirect_retry+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect queue_id("+v.ivrFlowNoInput_redirect_queue_id+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect queue_name("+v.ivrFlowNoInput_redirect_queue_name+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect ivr_id("+v.ivrFlowNoInput_redirect_ivr_id+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect dtmf("+v.ivrFlowNoInput_redirect_dtmf+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect child_dtmf_wait("+v.ivrFlowNoInput_redirect_child_dtmf_wait+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect dtmf_wait_time("+v.ivrFlowNoInput_redirect_dtmf_wait_time+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect expected_dtmf("+v.ivrFlowNoInput_redirect_expected_dtmf+")"),logger.log("DEB",v.channel.id,"ivr_detail","NoInput Redirect event_type("+v.ivrFlowNoInput_redirect_event_type+")"))):logger.log("DEB",v.channel.id,"ivr_detail","noinput_redirect no defined...")):logger.log("DEB",v.channel.id,"ivr_detail","NoInput no defined..."),"play"==v.geventType?(logger.log("IMP",v.channel.id,"ivr_detail","IVR Flow Event [Play]"),""!=v.gmediaFile?(v.ivrFlow_child_dtmf_wait,r(v.user_ivr_state)):(logger.log("ERR",v.channel.id,"ivr_detail","Play file is empty "+v.gmediaFile),logger.log("ERR",v.channel.id,"ivr_detail","Invalid Media, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))):"queue"==v.geventType?(logger.log("IMP",v.channel.id,"ivr_detail","IVR Flow Event [queue]"),n(v.channel)):logger.log("ERR",v.channel.id,"ivr_detail","Invalid Event "+v.geventType)):(logger.log("ERR",v.channel.id,"ivr_detail","Error thrown at url call"+e),logger.log("ERR",v.channel.id,"ivr_detail","Invalid Media, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))}))}function r(){var e;logger.log("IMP",v.channel.id,"ivr_detail","Inside start_playback"),v.userEnteredDtmf="",v.ignorePlaybackFinished_flag=!1,"IVR_INIT"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (IVR_INIT)"),logger.log("DEB",v.channel.id,"ivr_detail","Play ("+v.gcatDesc+") MediaFile("+v.gmediaFile+")"),logger.log("DEB",v.channel.id,"ivr_detail","ivrFlow_eventType("+v.ivrFlow_eventType+")"),logger.log("DEB",v.channel.id,"ivr_detail","ivrFlow_ivr_id("+v.ivrFlow_ivr_id+")"),current_sound="sound:"+v.gmediaFile,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):"IVR_POST_INIT"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (IVR_POST_INIT)"),logger.log("DEB",v.channel.id,"ivr_detail","Play ("+v.gcatDesc+") MediaFile("+v.gmediaFile+")"),logger.log("DEB",v.channel.id,"ivr_detail","ivrFlow_eventType("+v.ivrFlow_eventType+")"),logger.log("DEB",v.channel.id,"ivr_detail","ivrFlow_ivr_id("+v.ivrFlow_ivr_id+")"),current_sound="sound:"+v.gmediaFile,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):"INVALID_IVR_TREE"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (INVALID_IVR_TREE)"),logger.log("DEB",v.channel.id,"ivr_detail","Play ("+v.gcatDesc+") MediaFile("+v.gmediaFile+")"),current_sound="sound:"+cfg.media.dir+"/"+cfg.media.invalid_IVRTree+"-"+v.language,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):"INVALID_INPUT"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (INVALID_INPUT)"),logger.log("DEB",v.channel.id,"ivr_detail","Play ( INVALID_INPUT ) MediaFile("+v.gmediaFile+")"),current_sound="sound:"+v.gmediaFile,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):"NO_INPUT"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (NO_INPUT)"),logger.log("DEB",v.channel.id,"ivr_detail","Play ( NO_INPUT ) MediaFile("+v.gmediaFile+")"),current_sound="sound:"+v.gmediaFile,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):"NON_WORKING_DAY_IVR_TREE"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (NON_WORKING_DAY_IVR_TREE)"),logger.log("DEB",v.channel.id,"ivr_detail","Play MediaFile("+v.non_working_day_file+")"),e=v.non_working_day_file.replace(".mp3",""),current_sound="sound:"+v.non_working_day_file_path+"/"+e,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):"NON_WORKING_HOUR_IVR_TREE"==v.user_ivr_state?(logger.log("DEB",v.channel.id,"ivr_detail","IVR STATE (NON_WORKING_HOUR_IVR_TREE)"),logger.log("DEB",v.channel.id,"ivr_detail","Play MediaFile("+v.non_working_hour_file+")"),e=v.non_working_hour_file.replace(".mp3",""),current_sound="sound:"+v.non_working_hour_file_path+"/"+e,logger.log("DEB",v.channel.id,"ivr_detail","Going to play media["+current_sound+"]"),v.globalPlayback=v.client.Playback(),v.globalPlaybackFlag=!0,logger.log("DEB",v.channel.id,"ivr_detail","channel:",v.channel.caller),v.channel.play({media:current_sound},v.globalPlayback,function(e,i){e?logger.log("ERR",v.channel.id,"ivr_detail","...In Playback Handler:"+e):g(v.user_ivr_state,v.globalPlayback.id)})):logger.log("ERR",v.channel.id,"ivr_detail","Invalid DB response!")}function e(e){console.log(e),v.globalPlaybackFlag=!1;var i=function(e){logger.log("DEB",v.channel.id,"ivr_detail","Internal Function [getStateIvrMediaPlayArray]"),logger.log("DEB",v.channel.id,"ivr_detail","get state from id("+e+")");for(var i=0;i<v.ivrMediaPlayArray.length;i++){var l=v.ivrMediaPlayArray[i];if(l.id==e)return l.state}}(e.playback.id);logger.log("IMP",v.channel.id,"ivr_detail","Media Finished Playback State is ("+i+")"),"NON_WORKING_DAY_IVR_TREE"==i?(v.endCallDescription="non working day",(1==v.non_working_day_voicemail_flag?(logger.log("DEB",v.channel.id,"ivr_detail","NON_WORKING_DAY_IVR_TREE => transferCallSession"),d):(logger.log("DEB",v.channel.id,"ivr_detail","NON_WORKING_DAY_IVR_TREE no voicemail so cleanup.."),v.calldisconnectedBy="system",o))()):"NON_WORKING_HOUR_IVR_TREE"==i?(v.endCallDescription="non working hour",(1==v.non_working_hour_voicemail_flag?(logger.log("DEB",v.channel.id,"ivr_detail","NON_WORKING_HOUR_IVR_TREE => transferCallSession"),d):(logger.log("DEB",v.channel.id,"ivr_detail","NON_WORKING_HOUR_IVR_TREE no voicemail so cleanup.."),v.calldisconnectedBy="system",o))()):"IVR_INIT"==i||"IVR_POST_INIT"==i?(v.ivrFlowNoInput_retry_counting=1,v.ivrFlowInvalid_retry_counting=1,0==v.ignorePlaybackFinished_flag?(logger.log("DEB",v.channel.id,"ivr_detail","NoInput userEnteredDtmf("+v.userEnteredDtmf+"), ivrFlowNoInput_flag("+v.ivrFlowNoInput_flag+"), ivrFlow_child_dtmf_wait("+v.ivrFlow_child_dtmf_wait+")"),""==v.userEnteredDtmf&&1==v.ivrFlowNoInput_flag&&1==v.ivrFlow_child_dtmf_wait?(logger.log("DEB",v.channel.id,"ivr_detail","NoInput menu is ("+v.ivrFlowNoInput_flag+"), expected retry count("+v.ivrFlowNoInput_retry+"), retry done so far("+v.ivrFlowNoInput_retry_counting+")"),logger.log("DEB",v.channel.id,"ivr_detail","setting playback_finished_timeout @ state('+call.user_ivr_state+') in on_playback_finished"),v.setTimeout_playback_finished_id=setTimeout(t,1e3*v.ivtFlow_dtmf_wait_time,v.user_ivr_state)):"play"==v.geventType&&1==v.ivrFlow_child_dtmf_wait?(logger.log("DEB",v.channel.id,"ivr_detail","dtmf wait time is TRUE, so lets wait for "+v.ivtFlow_dtmf_wait_time+" seconds."),v.setTimeout_funIvrHandler_id=setTimeout(a,1e3*v.ivtFlow_dtmf_wait_time,v.user_ivr_state,0,!0,v.ivrFlow_ivr_id,0)):(logger.log("DEB",v.channel.id,"ivr_detail","dtmf wait time is FALSE, so lets get next IVR flow."),a(v.user_ivr_state,0,!0,v.ivrFlow_ivr_id,0))):logger.log("DEB",v.channel.id,"ivr_detail","ignore on_playback_finished  becz ignorePlaybackFinished_flag is true.")):"INVALID_INPUT"==i?0==v.ignorePlaybackFinished_flag?"play"==v.geventType&&1==v.ivrFlow_child_dtmf_wait?(logger.log("DEB",v.channel.id,"ivr_detail"," INVALID_INPUT dtmf wait time is TRUE, so lets wait for "+v.ivtFlow_dtmf_wait_time+" seconds."),v.setTimeout_funIvrHandler_id=setTimeout(l,1e3*v.ivtFlow_dtmf_wait_time,v.user_ivr_state,0,!0,v.ivrFlow_ivr_id,0)):logger.log("DEB",v.channel.id,"ivr_detail","INVALID_INPUT dtmf wait time is FALSE, so lets get next IVR flow."):logger.log("DEB",v.channel.id,"ivr_detail","ignore on_playback_finished  becz ignorePlaybackFinished_flag is true."):"NO_INPUT"==i?0==v.ignorePlaybackFinished_flag?""==v.userEnteredDtmf&&1==v.ivrFlowNoInput_flag&&1==v.ivrFlow_child_dtmf_wait?(logger.log("DEB",v.channel.id,"ivr_detail","NoInput menu (IF) is ("+v.ivrFlowNoInput_flag+"), expected retry count("+v.ivrFlowNoInput_retry+"), retry done so far("+v.ivrFlowNoInput_retry_counting+")"),logger.log("DEB",v.channel.id,"ivr_detail","setting playback_finished_timeout @ state("+v.user_ivr_state+") in on_playback_finished"),v.setTimeout_playback_finished_id=setTimeout(t,1e3*v.ivtFlow_dtmf_wait_time,"NO_INPUT")):logger.log("DEB",v.channel.id,"ivr_detail","NoInput menu (ELSE) is ("+v.ivrFlowNoInput_flag+"), expected retry count("+v.ivrFlowNoInput_retry+"), retry done so far("+v.ivrFlowNoInput_retry_counting+")"):logger.log("DEB",v.channel.id,"ivr_detail","ignore on_playback_finished  becz ignorePlaybackFinished_flag is true."):("INVALID_IVR_TREE"==i?logger.log("IMP",v.channel.id,"ivr_detail","Disconnecting this call"):logger.log("ERR",v.channel.id,"ivr_detail","Invalid state: "+v.user_ivr_state),v.calldisconnectedBy="system",v.endCallDescription="invalid call flow",o()),c(i,e.playback.id)}function t(e){logger.log("IMP",v.channel.id,"ivr_detail","timeout playback_finished_timeout for ("+e+")"),""==v.userEnteredDtmf?(logger.log("DEB",v.channel.id,"ivr_detail","NoInput menu is ("+v.ivrFlowNoInput_flag+"), expected retry count("+v.ivrFlowNoInput_retry+"), retry done so far("+v.ivrFlowNoInput_retry_counting+")"),v.ivrFlowNoInput_retry>=v.ivrFlowNoInput_retry_counting?(v.user_ivr_state="NO_INPUT",v.gmediaFile=v.ivrFlowNoInput_directory_path,v.ivrFlowNoInput_retry_counting=v.ivrFlowNoInput_retry_counting+1,r(v.currentState)):(logger.log("DEB",v.channel.id,"ivr_detail","NoInput retry count reached to limit, look for NoInput_retry menu."),v.geventType=v.ivrFlowNoInput_redirect_event_type,v.ivrFlow_ivr_id=v.ivrFlowNoInput_redirect_ivr_id,v.gmediaFile=v.ivrFlowNoInput_redirect_directory_path,v.gflowQueueId=v.ivrFlowNoInput_redirect_queue_id,v.gflowQueueName=v.ivrFlowNoInput_redirect_queue_name,v.gflowDtmf=v.ivrFlowNoInput_redirect_dtmf,v.ivrFlow_child_dtmf_wait=v.ivrFlowNoInput_redirect_child_dtmf_wait,v.ivtFlow_dtmf_wait_time=v.ivrFlowNoInput_redirect_dtmf_wait_time,v.ivtFlow_expected_dtmf=v.ivrFlowNoInput_redirect_expected_dtmf,v.ivrFlow_eventType=v.ivrFlowNoInput_redirect_event_type,v.ivrFlow_ivr_id=v.ivrFlowNoInput_redirect_ivr_id,v.ivrFlowNoInput_retry_counting=1,v.user_ivr_state="IVR_POST_INIT","play"==v.geventType&&(logger.log("IMP",v.channel.id,"ivr_detail","IVR Flow Event [Play]"),""!=v.gmediaFile?(v.ivrFlow_child_dtmf_wait,r(v.user_ivr_state)):(logger.log("ERR",v.channel.id,"ivr_detail","Play file is empty "+v.gmediaFile),logger.log("ERR",v.channel.id,"ivr_detail","Invalid Media, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))))):logger.log("IMP",v.channel.id,"ivr_detail","ignore playback_finished_timeout")}function n(){logger.log("IMP",v.channel.id,"ivr_detail","makeCallAgent"),v.callgroupid=v.gcatDesc,"1"!=v.gValidDtmfFlag?(logger.log("DEB",v.channel.id,"ivr_detail","call.gValidDtmfFlag is not 1 here.., hitting transferCallSession"),v.timeToMakeCallNow=!0,d()):logger.log("DEB",v.channel.id,"ivr_detail","call.gValidDtmfFlag is 1 here.., dont transferCallSession")}function i(e,i){logger.log("IMP",v.channel.id,"ivr_detail"," ***** DTMF EVENT ["+e.digit+"] *****"),v.allIvrDtmf?v.allIvrDtmf=v.allIvrDtmf+","+e.digit:v.allIvrDtmf=e.digit,logger.log("DEB",v.channel.id,"ivr_detail","finally I have dtmf("+v.allIvrDtmf+")"),"IVR_INIT"==v.user_ivr_state?logger.log("DEB",v.channel.id,"ivr_detail","ignore dtmf because this is our welcome defualt.."):(v.userEnteredDtmf=e.digit,void 0!==v.setTimeout_playback_finished_id?(clearTimeout(v.setTimeout_playback_finished_id),logger.log("DEB",v.channel.id,"ivr_detail","setTimeout_playback_finished_id Timeout cleared.")):logger.log("DEB",v.channel.id,"ivr_detail","setTimeout_playback_finished_id Timeout is not set."),1==v.globalPlaybackFlag?(logger.log("DEB",v.channel.id,"ivr_detail","check if still media is playing...Yes(true)"),v.channel?(logger.log("DEB",v.channel.id,"ivr_detail","stopping playing file ("+v.gmediaFile+")"),v.globalPlayback.stop(),v.globalPlaybackFlag=!1):logger.log("DEB",v.channel.id,"ivr_detail","(no channel)")):logger.log("DEB",v.channel.id,"ivr_detail","globalPlaybackFlag (false )"),v.ignorePlaybackFinished_flag=!0,logger.log("DEB",v.channel.id,"ivr_detail","DTMF Event ("+e.digit+") for played file ("+v.gmediaFile+")"),1==v.non_working_hour_flag||1==v.non_working_day_flag?logger.log("DEB",v.channel.id,"ivr_detail","Active -> non_working_hour_flag("+v.non_working_hour_flag+") or non_working_day_flag("+v.non_working_day_flag+"), So Ignore DTMF"):(logger.log("DEB",v.channel.id,"ivr_detail","check if still media is playing..."),"play"==v.geventType?(logger.log("DEB",v.channel.id,"ivr_detail","check if still media is playing...Yes(play type)"),1==(!(!v.ivtFlow_expected_dtmf||null==v.ivtFlow_expected_dtmf||null==v.ivtFlow_expected_dtmf)&&v.ivtFlow_expected_dtmf.includes(e.digit))?(logger.log("DEB",v.channel.id,"ivr_detail","Expected Child Menu DTMF matches"),a(v.user_ivr_state,e.digit,!1,v.ivrFlow_ivr_id,0)):(logger.log("DEB",v.channel.id,"ivr_detail","Expected Child Menu DTMF("+v.ivtFlow_expected_dtmf+") Dont matches"),logger.log("DEB",v.channel.id,"ivr_detail","Invalid menu is ("+v.ivrFlowInvalid_flag+"), expected retry count("+v.ivrFlowInvalid_retry+"), retry done so far("+v.ivrFlowInvalid_retry_counting+")"),v.user_ivr_state,1==v.ivrFlowInvalid_flag&&v.ivtFlow_expected_dtmf&&null!=v.ivtFlow_expected_dtmf&&null!=v.ivtFlow_expected_dtmf?(logger.log("DEB",v.channel.id,"ivr_detail","Invalid menu is ("+v.ivrFlowInvalid_flag+"), expected retry count("+v.ivrFlowInvalid_retry+"), retry done so far("+v.ivrFlowInvalid_retry_counting+")"),v.ivrFlowInvalid_retry>=v.ivrFlowInvalid_retry_counting?(v.user_ivr_state="INVALID_INPUT",v.gmediaFile=v.ivrFlowInvalid_directory_path,v.ivrFlowInvalid_retry_counting=v.ivrFlowInvalid_retry_counting+1,r(v.currentState)):(logger.log("DEB",v.channel.id,"ivr_detail","invalid retry count reached to limit, look for invalid_retry menu."),v.geventType=v.ivrFlowInvalid_redirect_event_type,v.ivrFlow_ivr_id=v.ivrFlowInvalid_redirect_ivr_id,v.gmediaFile=v.ivrFlowInvalid_redirect_directory_path,v.gflowQueueId=v.ivrFlowInvalid_redirect_queue_id,v.gflowQueueName=v.ivrFlowInvalid_redirect_queue_name,v.gflowDtmf=v.ivrFlowInvalid_redirect_dtmf,v.ivrFlow_child_dtmf_wait=v.ivrFlowInvalid_redirect_child_dtmf_wait,v.ivtFlow_dtmf_wait_time=v.ivrFlowInvalid_redirect_dtmf_wait_time,v.ivtFlow_expected_dtmf=v.ivrFlowInvalid_redirect_expected_dtmf,v.ivrFlowInvalid_retry_counting=1,v.user_ivr_state="IVR_POST_INIT","play"==v.geventType&&(logger.log("IMP",v.channel.id,"ivr_detail","IVR Flow Event [Play]"),""!=v.gmediaFile?(v.ivrFlow_child_dtmf_wait,r(v.user_ivr_state)):(logger.log("ERR",v.channel.id,"ivr_detail","Play file is empty "+v.gmediaFile),logger.log("ERR",v.channel.id,"ivr_detail","Invalid Media, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))))):(logger.log("WARNING",v.channel.id,"ivr_detail","no matched dtmf but NO invalid ivr flow"),a(v.user_ivr_state,e.digit,!1,v.ivrFlow_ivr_id,0)))):logger.log("DEB",v.channel.id,"ivr_detail","type not defined ("+v.geventType+" )")))}function d(){v.IvrEndTime=dateTime.getAgentDateTime(),v.IvrCallDuration=dateTime.calculateDuration(v.callstartDateTime,v.IvrEndTime),logger.log("DEB",v.channel.id,"ivr_detail","||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||"),logger.log("DEB",v.channel.id,"ivr_detail","IvrCallDuration("+v.IvrCallDuration+")"),logger.log("DEB",v.channel.id,"ivr_detail","||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||"),v.finalDTMF=v.gvalidDtmf,logger.log("DEB",v.channel.id,"ivr_detail","finalDTMF("+v.finalDTMF+")"),logger.log("IMP",v.channel.id,"ivr_detail","Inside clearprocess function"),v.channel.removeListener("ChannelDtmfReceived",i),v.channel.removeListener("PlaybackFinished",e),v.channel.removeListener("ChannelDtmfReceived",i),v.channel.removeListener("PlaybackFinished",e),v.client.removeListener("PlaybackFinished",e),"NON_WORKING_DAY_IVR_TREE"==v.user_ivr_state||"NON_WORKING_HOUR_IVR_TREE"==v.user_ivr_state?(v.callvoicemailstate="SIMPLE_PLAY_WELCOME_VM",logger.log("DEB",v.channel.id,"ivr_detail","State-Machine Update to ==> [Event.VOICEMAIL]"),v.state_machine.change_state(Event.VOICEMAIL)):"0"<v.parallelRingingChannels?(logger.log("DEB",v.channel.id,"ivr_detail","State-Machine Update to ==> [Event.IVR_RECEIVED_PR]"),v.state_machine.change_state(Event.IVR_RECEIVED_PR)):(logger.log("DEB",v.channel.id,"ivr_detail","State-Machine Update to ==> [Event.IVR_RECEIVED]"),v.state_machine.change_state(Event.IVR_RECEIVED))}function o(){logger.log("IMP",v.channel.id,"ivr_detail","Inside cleanup function"),v.channel.removeListener("ChannelHangupRequest",_),v.channel.hangup(function(e){})}function _(e,i){logger.log("IMP",v.channel.id,"ivr_detail","Inside on_hangup"),logger.log("DEB",i.id,"ivr_detail","1 calldisconnectedBy:"+i.calldisconnectedBy),logger.log("DEB",i.id,"ivr_detail","2 calldisconnectedBy:"+v.calldisconnectedBy),logger.log("DEB",i.id,"ivr_detail","3 calldisconnectedBy:"+v.channel.calldisconnectedBy),o(),logger.log("DEB",v.channel.id,"ivr_detail","State-Machine Update to ==> [Event.HANGUP]"),v.state_machine.change_state(Event.HANGUP)}function g(e,i){logger.log("DEB",v.channel.id,"ivr_detail","Internal Function [addIvrMediaPlayArray]"),logger.log("DEB",v.channel.id,"ivr_detail","add array: state("+e+"), id("+i+")"),v.ivrMediaPlayArray.push({id:i,state:e})}function c(e,i){logger.log("DEB",v.channel.id,"ivr_detail","Internal Function [removeIvrMediaPlayArray]"),logger.log("DEB",v.channel.id,"ivr_detail","splice/remove from array: state("+e+"), id("+i+")");for(var l=0;l<v.ivrMediaPlayArray.length;l++)v.ivrMediaPlayArray[l].id==i&&v.ivrMediaPlayArray.splice(l,1)}logger.log("IMP",v.channel.id,"ivr_detail","Entering user_ivr state:user_ivr_state"),logger.log("DEB",v.channel.id,"ivr_detail","Uniqe Session ID: "+v.channel.callSessionId),v.client.on("PlaybackFinished",e),v.channel.on("ChannelDtmfReceived",i),v.language="e",1==v.non_working_day_flag?(logger.log("DEB",v.channel.id,"ivr_detail","playing non working day file("+v.non_working_day_file+")"),v.user_ivr_state="NON_WORKING_DAY_IVR_TREE",r(v.currentState)):1==v.non_working_hour_flag?(logger.log("DEB",v.channel.id,"ivr_detail","playing non working hour file("+v.non_working_hour_file+")"),v.user_ivr_state="NON_WORKING_HOUR_IVR_TREE",r(v.currentState)):0!=v.callProfileObj.data.ivrFlow.length?(v.geventType=v.callProfileObj.data.ivrFlow[0].event_type,v.ivrFlow_ivr_id=v.callProfileObj.data.ivrFlow[0].id,v.callProfileObj.data.ivrFlow[0].directory_path?v.gmediaFile=v.callProfileObj.data.ivrFlow[0].directory_path.replace(".wav",""):v.gmediaFile=v.callProfileObj.data.ivrFlow[0].directory_path,v.gflowQueueId=v.callProfileObj.data.ivrFlow[0].queue_id,v.gflowQueueName=v.callProfileObj.data.ivrFlow[0].queue_name,v.gflowDtmf=v.callProfileObj.data.ivrFlow[0].dtmf,v.ivrCallFlowName=v.callProfileObj.data.ivrFlow[0].flow_name,logger.log("DEB",v.channel.id,"ivr_detail","geventType: "+v.geventType),logger.log("DEB",v.channel.id,"ivr_detail","ivrFlow_ivr_id: "+v.ivrFlow_ivr_id),logger.log("DEB",v.channel.id,"ivr_detail","ivrCallFlowName: "+v.ivrCallFlowName),logger.log("DEB",v.channel.id,"ivr_detail","gmediaFile: "+v.gmediaFile),logger.log("DEB",v.channel.id,"ivr_detail","gflowQueueId: "+v.gflowQueueId),logger.log("DEB",v.channel.id,"ivr_detail","gflowQueueName: "+v.gflowQueueName),v.user_ivr_state="IVR_INIT","play"==v.geventType?(logger.log("IMP",v.channel.id,"ivr_detail","IVR Flow Event [Play]"),""!=v.gmediaFile?(v.ivrFlow_child_dtmf_wait,r(v.user_ivr_state)):(logger.log("ERR",v.channel.id,"ivr_detail","Play file is empty "+v.gmediaFile),logger.log("ERR",v.channel.id,"ivr_detail","Invalid Media, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))):"queue"==v.geventType?(logger.log("IMP",v.channel.id,"ivr_detail","IVR Flow Event [queue]"),n(v.channel)):(logger.log("ERR",v.channel.id,"ivr_detail","Invalid Event "+v.geventType),logger.log("ERR",v.channel.id,"ivr_detail","Invalid API Main response, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))):(logger.log("ERR",v.channel.id,"ivr_detail","Invalid API response, play thanks and disconnect the call"),v.user_ivr_state="INVALID_IVR_TREE",r(v.currentState))}}module.exports=GetIvrDetail;