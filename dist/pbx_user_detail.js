var Event=require("./events"),cfg=require("../../pbx_config"),pbx_api=require("./api/pbx_api"),pbx_db=require("./pbx_db"),agent_processor=require("./agent_processor"),StringDecoder=require("string_decoder").StringDecoder,pbx_logger=require("./logger/pbx_logger"),dt=require("./common/datetime"),logger=new pbx_logger,dbOutput="",dbSMEid="",api=new pbx_api,dateTime=new dt,agentProcessor=new agent_processor;function GetSmeDetail(t){this.state_name="user_detail_state",this.enter=function(){new pbx_db;logger.log("IMP",t.channel.id,"user_detail","Internal Function [GetSmeDetail]"),logger.log("DEB",t.channel.id,"user_detail","Entering user_detail state: user_detail_state"),t.language="pa";var e=dateTime.getDateTimeString2V();t.callSessionId="pbx_"+t.channel.id+"_"+e;function i(){logger.log("IMP",t.channel.id,"user_detail","Internal Function [cleanup]"),"1"==t.idealAgentFlag&&(logger.log("DEB",t.channel.id,"user_detail","calling makeAgentFree to mark the tried agent idle"),agentProcessor.freeAgent(t)),t.channel.removeListener("ChannelHangupRequest",a)}function g(){logger.log("IMP",t.channel.id,"user_detail","Internal Function [hangupBlackListCall]"),t.channel.removeListener("ChannelHangupRequest",a),t.channel.hangup(function(e){e?logger.log("ERR",t.channel.id,"user_detail","Error while hangup main blacklist leg."+e):logger.log("DEB",t.channel.id,"user_detail","success while hangup main blacklist leg.")})}function a(e,a){logger.log("IMP",t.channel.id,"user_detail","ON Event [on_hangup]"),"0"===t.initOnHangup&&(t.initOnHangup="1",logger.log("DEB",t.channel.id,"user_detail","initOnHangup("+t.initOnHangup+") activated.")),i(),logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => HANGUP]"),t.state_machine.change_state(Event.HANGUP)}logger.log("DEB",t.channel.id,"user_detail","going to call function getSmeId for CallingNumber("+t.channel.caller.number+") and CalledNumber("+t.channel.dialplan.exten+"), callSessionId("+t.callSessionId+"), self_ip("+cfg.server.self_ip+")"),api.funFetchCallProfile(t.channel.id,t.channel.caller.number,t.channel.dialplan.exten,cfg.server.self_ip,t.callSessionId,function(e,a,n){var l;t.callProfileObj=n,e?(logger.log("ERR",t.channel.id,"user_detail","Error thrown at DB call: "+e),logger.log("ERR",t.channel.id,"user_detail","invalid SME call("+t.channel.dialplan.exten+")"),logger.log("DEB",t.channel.id,"user_detail","cleanup.."),i()):(logger.log("DEB",t.channel.id,"user_detail","API Status:"+n.status),logger.log("DEB",t.channel.id,"user_detail","API Message:"+n.message),n&&n.status&&"0"!=n.status&&n.data&&n.data.sme_profile&&null!=n.data.sme_profile[0].id?(t.smeID=n.data.sme_profile[0].id,logger.log("DEB",t.channel.id,"user_detail","sme_id:"+t.smeID),t.calllongcode=t.channel.dialplan.exten,logger.log("DEB",t.channel.id,"user_detail","longcode:"+t.calllongcode),t.smeAlgorithm=n.data.sme_profile[0].selection_algo,logger.log("DEB",t.channel.id,"user_detail","selection_algo:"+t.smeAlgorithm),t.queue_limit=n.data.sme_profile[0].queue_limit,logger.log("DEB",t.channel.id,"user_detail","queue_limit:"+t.queue_limit),t.smerecording=n.data.sme_profile[0].recording,logger.log("DEB",t.channel.id,"user_detail","recording:"+t.smerecording),t.smemasking=n.data.sme_profile[0].masking,logger.log("DEB",t.channel.id,"user_detail","masking:"+t.smemasking),t.smevoicemail=n.data.sme_profile[0].voicemail,logger.log("DEB",t.channel.id,"user_detail","voicemail:"+t.smevoicemail),t.smestatus=n.data.sme_profile[0].status,logger.log("DEB",t.channel.id,"user_detail","status:"+t.smestatus),t.smeBillingStatus=n.data.sme_profile[0].billing_status,logger.log("DEB",t.channel.id,"user_detail","status:"+t.smeBillingStatus),t.gliveEvents=n.data.sme_profile[0].live_events,logger.log("DEB",t.channel.id,"user_detail","liveEvents:"+t.gliveEvents),t.accountSid=n.data.sme_profile[0].account_sid,logger.log("DEB",t.channel.id,"user_detail","account_sid:"+t.accountSid),t.smeStickyAlgo=n.data.sme_profile[0].sticky_algo,logger.log("DEB",t.channel.id,"user_detail","smeStickyAlgo:"+t.smeStickyAlgo),t.callsmeIdentifier=t.smeID,logger.log("DEB",t.channel.id,"user_detail","callsmeIdentifier:"+t.callsmeIdentifier),t.callHlr=t.callHlr,logger.log("DEB",t.channel.id,"user_detail","callHlr:"+t.callHlr),t.callmasterShortcode=t.channel.dialplan.exten,logger.log("DEB",t.channel.id,"user_detail","callmasterShortcode:"+t.callmasterShortcode),t.endCallNotificationFlag=n.data.sme_profile[0].end_call_notification_flag,logger.log("DEB",t.channel.id,"user_detail","endCallNotificationFlag:"+t.endCallNotificationFlag),t.parallelRingingChannels=n.data.sme_profile[0].parallel_ringing_channels,logger.log("DEB",t.channel.id,"user_detail","parallelRingingChannels:"+t.parallelRingingChannels),t.leadManagerPermissionFlag=n.data.sme_profile[0].lead_manager_permission_flag,logger.log("DEB",t.channel.id,"user_detail","leadManagerPermissionFlag:"+t.leadManagerPermissionFlag),t.all_call_mode=n.data.sme_profile[0].call_mode,logger.log("DEB",t.channel.id,"user_detail","all_call_mode:"+t.all_call_mode),t.incoming_permission_flag=n.data.sme_profile[0].in_permission_flag,logger.log("DEB",t.channel.id,"user_detail","incoming_permission_flag:"+t.incoming_permission_flag),t.outgoing_permission_flag=n.data.sme_profile[0].out_permission_flag,logger.log("DEB",t.channel.id,"user_detail","outgoing_permission_flag:"+t.outgoing_permission_flag),t.in_channels_capacity=n.data.sme_profile[0].in_channels,logger.log("DEB",t.channel.id,"user_detail","in_channels_capacity:"+t.in_channels_capacity),t.out_channels_capacity=n.data.sme_profile[0].out_channels,logger.log("DEB",t.channel.id,"user_detail","out_channels_capacity:"+t.out_channels_capacity),t.total_webrtc_channels=n.data.sme_profile[0].webrtc_channel,logger.log("DEB",t.channel.id,"user_detail","total_webrtc_channels:"+t.total_webrtc_channels),t.jinglePlayPermission=n.data.sme_profile[0].jingle_flag,logger.log("DEB",t.channel.id,"user_detail","jinglePlayPermission:"+t.jinglePlayPermission),t.agentRingingTime="0",logger.log("DEB",t.channel.id,"user_detail","agentRingingTime:"+t.agentRingingTime),0!=n.data.self_liveCalls.length&&(t.self_Sme_liveCalls_total=n.data.self_liveCalls[0].LiveCalls,logger.log("DEB",t.channel.id,"user_detail","self_Sme_liveCalls_total:"+t.self_Sme_liveCalls_total),t.self_Sme_liveCalls_incoming=n.data.self_liveCalls[0].incomingCalls,logger.log("DEB",t.channel.id,"user_detail","self_Sme_liveCalls_incoming:"+t.self_Sme_liveCalls_incoming),t.self_Sme_liveCalls_outgoing=n.data.self_liveCalls[0].outgoingCalls,logger.log("DEB",t.channel.id,"user_detail","self_Sme_liveCalls_outgoing:"+t.self_Sme_liveCalls_outgoing)),0!=n.data.all_Sme_liveCalls.length&&(t.all_Sme_liveCalls_total=n.data.all_Sme_liveCalls[0].LiveCalls,logger.log("DEB",t.channel.id,"user_detail","all_Sme_liveCalls_total:"+t.all_Sme_liveCalls_total),t.all_Sme_liveCalls_incoming=n.data.all_Sme_liveCalls[0].incomingCalls,logger.log("DEB",t.channel.id,"user_detail","all_Sme_liveCalls_incoming:"+t.all_Sme_liveCalls_incoming),t.all_Sme_liveCalls_outgoing=n.data.all_Sme_liveCalls[0].outgoingCalls,logger.log("DEB",t.channel.id,"user_detail","all_Sme_liveCalls_outgoing:"+t.all_Sme_liveCalls_outgoing)),0!=n.data.crmList.length&&(t.crmPartner=n.data.crmList[0].crm_partner,logger.log("DEB",t.channel.id,"user_detail","crmPartner:"+t.crmPartner),t.smsPartner=n.data.crmList[0].sms_provider,logger.log("DEB",t.channel.id,"user_detail","smsPartner:"+t.smsPartner)),0!=n.data.addressBook.length&&(t.address_book_id=n.data.addressBook[0].id,logger.log("DEB",t.channel.id,"user_detail","address_book_id:"+t.address_book_id),t.address_book_name=n.data.addressBook[0].customer_name,logger.log("DEB",t.channel.id,"user_detail","address_book_name:"+t.address_book_name)),0!=n.data.agent_assigned_longcode.length&&(n.data.agent_assigned_longcode&&n.data.agent_assigned_longcode[0]&&n.data.agent_assigned_longcode[0].longcode&&(t.agentAssignedVN=n.data.agent_assigned_longcode[0].longcode,logger.log("DEB",t.channel.id,"user_detail","agentAssignedVN:"+t.agentAssignedVN)),n.data.agent_assigned_longcode&&n.data.agent_assigned_longcode[0]&&n.data.agent_assigned_longcode[0].agent_id&&(t.agentAssignedVNAgentID=n.data.agent_assigned_longcode[0].agent_id,logger.log("DEB",t.channel.id,"user_detail","agentAssignedVNAgentID:"+t.agentAssignedVNAgentID)),n.data.agent_assigned_longcode&&n.data.agent_assigned_longcode[0]&&n.data.agent_assigned_longcode[0].number_type&&(t.agentAssignedVNAgentType=n.data.agent_assigned_longcode[0].number_type,logger.log("DEB",t.channel.id,"user_detail","agentAssignedVNAgentType:"+t.agentAssignedVNAgentType)),n.data.agent_assigned_longcode)&&n.data.agent_assigned_longcode[0]&&n.data.agent_assigned_longcode[0].STATUS&&(t.agentAssignedVNAgentStatus=n.data.agent_assigned_longcode[0].STATUS,logger.log("DEB",t.channel.id,"user_detail","agentAssignedVNAgentStatus:"+t.agentAssignedVNAgentStatus)),0!=n.data.non_working_day.length&&0!=t.smeBillingStatus?(n.data.non_working_day&&n.data.non_working_day[0]&&n.data.non_working_day[0].non_working_day_profile&&1==n.data.non_working_day[0].non_working_day_profile?(logger.log("DEB",t.channel.id,"user_detail","non_working_day_profile: "+n.data.non_working_day[0].non_working_day_profile),n.data.non_working_day&&n.data.non_working_day[0]&&n.data.non_working_day[0].file_name?(t.non_working_day_file=n.data.non_working_day[0].file_name,logger.log("DEB",t.channel.id,"user_detail","non_working_day_file: "+t.non_working_day_file),n.data.non_working_day&&n.data.non_working_day[0]&&n.data.non_working_day[0].transcode_status&&1==n.data.non_working_day[0].transcode_status?(t.non_working_day_transcode_status=n.data.non_working_day[0].transcode_status,logger.log("DEB",t.channel.id,"user_detail","non_working_day_transcode_status: "+t.non_working_day_transcode_status),n.data.non_working_day&&n.data.non_working_day[0]&&n.data.non_working_day[0].directory_path?(t.non_working_day_file_path=n.data.non_working_day[0].directory_path,logger.log("DEB",t.channel.id,"user_detail","non_working_day_file_path: "+t.non_working_day_file_path),t.non_working_day_flag=!0,logger.log("DEB",t.channel.id,"user_detail","FINAL - non_working_day_flag: "+t.non_working_day_flag)):(logger.log("DEB",t.channel.id,"user_detail","invalid! directory_path: "+t.non_working_day_file_path),t.non_working_day_flag=!1)):(logger.log("DEB",t.channel.id,"user_detail","invalid! non_working_day_transcode_status: "+t.non_working_day_transcode_status),t.non_working_day_flag=!1)):(logger.log("DEB",t.channel.id,"user_detail","invalid! non_working_day_file: "+t.non_working_day_file),t.non_working_day_flag=!1)):(logger.log("DEB",t.channel.id,"user_detail","inactive! non_working_day_profile: "+t.non_working_day_profile),t.non_working_day_flag=!1),n.data.non_working_day&&n.data.non_working_day[0]&&n.data.non_working_day[0].redirect_to_voicemail&&1==n.data.non_working_day[0].redirect_to_voicemail&&(t.non_working_day_voicemail_flag=!0,logger.log("DEB",t.channel.id,"user_detail","redirect_to_voicemail: true :"+n.data.non_working_day[0].redirect_to_voicemail))):logger.log("DEB",t.channel.id,"user_detail","non_working_day_profile not found.."),0!=n.data.non_working_hour.length&&0!=t.smeBillingStatus?(n.data.non_working_hour&&n.data.non_working_hour[0]&&n.data.non_working_hour[0].non_working_hour_profile&&1==n.data.non_working_hour[0].non_working_hour_profile?(logger.log("DEB",t.channel.id,"user_detail","non_working_hour_profile: "+n.data.non_working_hour[0].non_working_hour_profile),n.data.non_working_hour&&n.data.non_working_hour[0]&&n.data.non_working_hour[0].file_name?(t.non_working_hour_file=n.data.non_working_hour[0].file_name,logger.log("DEB",t.channel.id,"user_detail","non_working_hour_file: "+t.non_working_hour_file),n.data.non_working_hour&&n.data.non_working_hour[0]&&n.data.non_working_hour[0].transcode_status&&1==n.data.non_working_hour[0].transcode_status?(t.non_working_hour_transcode_status=n.data.non_working_hour[0].transcode_status,logger.log("DEB",t.channel.id,"user_detail","non_working_hour_transcode_status: "+t.non_working_hour_transcode_status),n.data.non_working_hour&&n.data.non_working_hour[0]&&n.data.non_working_hour[0].directory_path?(t.non_working_hour_file_path=n.data.non_working_hour[0].directory_path,logger.log("DEB",t.channel.id,"user_detail","non_working_hour_file_path: "+t.non_working_hour_file_path),t.non_working_hour_flag=!0,logger.log("DEB",t.channel.id,"user_detail","FINAL - non_working_hour_flag: "+t.non_working_hour_flag)):(logger.log("DEB",t.channel.id,"user_detail","invalid! directory_path: "+t.non_working_hour_file_path),t.non_working_hour_flag=!1)):(logger.log("DEB",t.channel.id,"user_detail","invalid! non_working_hour_transcode_status: "+t.non_working_hour_transcode_status),t.non_working_hour_flag=!1)):(logger.log("DEB",t.channel.id,"user_detail","invalid! non_working_hour_file: "+t.non_working_hour_file),t.non_working_hour_flag=!1)):(logger.log("DEB",t.channel.id,"user_detail","inactive! non_working_hour_profile: "+t.non_working_hour_profile),t.non_working_hour_flag=!1),n.data.non_working_hour&&n.data.non_working_hour[0]&&n.data.non_working_hour[0].redirect_to_voicemail&&1==n.data.non_working_hour[0].redirect_to_voicemail&&(t.non_working_hour_voicemail_flag=!0,logger.log("DEB",t.channel.id,"user_detail","redirect_to_voicemail: true :"+n.data.non_working_hour[0].redirect_to_voicemail))):logger.log("DEB",t.channel.id,"user_detail","non_working_hour_profile not found.."),0!=n.data.out_virtual_longcode.length&&(logger.log("DEB",t.channel.id,"user_detail","Return Virtual/DID response."),t.outVirtualNo=n.data.out_virtual_longcode[0].longcode,logger.log("DEB",t.channel.id,"user_detail","outgoing longcode:"+t.outVirtualNo),t.outVirtualNo="+"+t.outVirtualNo,logger.log("DEB",t.channel.id,"user_detail","after adding + in virtualNo:"+t.outVirtualNo),logger.log("DEB",t.channel.id,"user_detail","id:"+n.data.out_virtual_longcode[0].id),logger.log("DEB",t.channel.id,"user_detail","status:"+n.data.out_virtual_longcode[0].status),logger.log("DEB",t.channel.id,"user_detail","location:"+n.data.out_virtual_longcode[0].location),logger.log("DEB",t.channel.id,"user_detail","type:"+n.data.out_virtual_longcode[0].type),logger.log("DEB",t.channel.id,"user_detail","operator:"+n.data.out_virtual_longcode[0].operator),logger.log("DEB",t.channel.id,"user_detail","number_type:"+n.data.out_virtual_longcode[0].number_type),n.data.out_virtual_longcode)&&n.data.out_virtual_longcode[0]&&n.data.out_virtual_longcode.agent_id&&logger.log("DEB",t.channel.id,"user_detail","this did/virtual no is assigned to"+n.data.out_virtual_longcode[0].number_type),0!=n.data.assignedAgent.length&&n.data.assignedAgent.agent_id&&1!=n.data.assignedAgent.agent_id&&2!=n.data.assignedAgent.agent_id&&(t.assigned_agent_id=n.data.assignedAgent.agent_id,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_id:"+t.assigned_agent_id),t.assigned_agent_name=n.data.assignedAgent.agent_name,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_name:"+t.assigned_agent_name),t.assigned_agent_mobile=n.data.assignedAgent.agent_mobile,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_mobile:"+t.assigned_agent_mobile),t.assigned_agent_status_int=n.data.assignedAgent.status,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_status_int:"+t.assigned_agent_status_int),t.assigned_agent_email=n.data.assignedAgent.agent_email,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_email:"+t.assigned_agent_email),t.assigned_agent_sticky_type=n.data.assignedAgent.sticky_type,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_sticky_type:"+t.assigned_agent_sticky_type),t.assigned_agent_group=n.data.assignedAgent.group_name,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_group:"+t.assigned_agent_group),t.assigned_agent_webrtc_flag=n.data.assignedAgent.webrtc_flag,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_webrtc_flag:"+t.assigned_agent_webrtc_flag),t.assigned_agent_webrtc_registered_duration=n.data.assignedAgent.webrtc_registered_duration,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_webrtc_registered_duration:"+t.assigned_agent_webrtc_registered_duration),t.assigned_agent_webrtc_registered_flag=n.data.assignedAgent.webrtc_registered_flag,logger.log("DEB",t.channel.id,"user_detail","assigned_agent_webrtc_registered_flag:"+t.assigned_agent_webrtc_registered_flag),e="","1"==t.assigned_agent_sticky_type?e="Lead Soft Sticky":"2"==t.assigned_agent_sticky_type&&(e="Lead Hard Sticky"),l="","0"==t.assigned_agent_status_int?l="Inactive":"1"==t.assigned_agent_status_int?l="Idle":"2"==t.assigned_agent_status_int?l="Busy":"3"==t.assigned_agent_status_int?l="Break":"3"==t.assigned_agent_status_int&&(l="Other"),t.endCallDescription="("+t.assigned_agent_name+" | "+l+" | "+e+")",t.callpatchedAgentId=t.assigned_agent_id),0!=n.data.sme_ivr_plan.length?(console.log(n.data.sme_ivr_plan),t.packId=n.data.sme_ivr_plan[0].package_id,logger.log("DEB",t.channel.id,"user_detail","packId:"+t.packId),t.packMinutes=n.data.sme_ivr_plan[0].minutes,logger.log("DEB",t.channel.id,"user_detail","packMinutes:"+t.packMinutes),t.packNoOfCalls=n.data.sme_ivr_plan[0].no_of_calls,logger.log("DEB",t.channel.id,"user_detail","packNoOfCalls:"+t.packNoOfCalls),t.packValidayDaysLeft=n.data.sme_ivr_plan[0].validay_days_left,logger.log("DEB",t.channel.id,"user_detail","packValidayDaysLeft:"+t.packValidayDaysLeft),t.packType=n.data.sme_ivr_plan[0].type,logger.log("DEB",t.channel.id,"user_detail","packType:"+t.packType),t.packUnlimitedCallsFlag=n.data.sme_ivr_plan[0].unlimited_calls,logger.log("DEB",t.channel.id,"user_detail","packUnlimitedCallsFlag:"+t.packUnlimitedCallsFlag),t.planTypeDetail=n.data.sme_ivr_plan[0].pack_type,logger.log("DEB",t.channel.id,"user_detail","planTypeDetail:"+t.planTypeDetail)):(t.packId="0",t.packMinutes="0",t.packNoOfCalls="0",t.packUnlimitedCallsFlag="0",t.packValidayDaysLeft="0",t.packType="0"),0!=n.data.smePrompt.length&&"MUSIC_ON_HOLD"==n.data.smePrompt[0].prompt_key&&(t.dbMusicOnHoldPrompt=n.data.smePrompt[0].prompt_name.replace(".wav",""),logger.log("DEB",t.channel.id,"user_detail","dbMusicOnHoldPrompt:"+t.dbMusicOnHoldPrompt)),0!=n.data.agentList.length&&(t.idealAgentID=n.data.agentList[0].agent_id,logger.log("DEB",t.channel.id,"user_detail","idealAgentID:"+t.idealAgentID),t.idealAgentGroup=n.data.agentList[0].group_name,logger.log("DEB",t.channel.id,"user_detail","idealAgentGroup:"+t.idealAgentGroup),t.idealAgentNumber=n.data.agentList[0].agent_mobile,logger.log("DEB",t.channel.id,"user_detail","idealAgentNumber:"+t.idealAgentNumber),t.agentEmail=n.data.agentList[0].agent_email,logger.log("DEB",t.channel.id,"user_detail","agentEmail:"+t.agentEmail),t.idealAgentFlag="1",t.callMode="IVR_OUT",t.callpatchedAgentGroup=t.idealAgentGroup,t.callanswerFlag=1,logger.log("DEB",t.channel.id,"user_detail","agentid: "+t.idealAgentID),logger.log("DEB",t.channel.id,"user_detail","agentgroup: "+t.idealAgentGroup),logger.log("DEB",t.channel.id,"user_detail","agentnumber: "+t.idealAgentNumber)),logger.log("IMP",t.channel.id,"user_detail","[VALIDITY_CHECK] - Checking Pack Valaidity Days Left("+t.packValidayDaysLeft+")"),0<t.packValidayDaysLeft?logger.log("IMP",t.channel.id,"user_detail","[VALIDITY_CHECK] -Your Pack Valaidy is OK ("+t.packValidayDaysLeft+")"):(logger.log("IMP",t.channel.id,"user_detail","[VALIDITY_CHECK] -Your Pack Valaidy is expired ("+t.packValidayDaysLeft+")"),logger.log("IMP",t.channel.id,"user_detail","CALL NOT ALLOWED!")),logger.log("IMP",t.channel.id,"user_detail","[CAPACITY_CHECK] - Incoming Capacity Check"),logger.log("DEB",t.channel.id,"user_detail",t.smeID+" Live Incoming Calls("+t.self_Sme_liveCalls_incoming+") & Capacity("+t.in_channels_capacity+")"),t.self_Sme_liveCalls_incoming>t.in_channels_capacity?(logger.log("INFO",t.channel.id,"user_detail",t.smeID+" Incoming Calls Out Of Capacity!"),logger.log("INFO",t.channel.id,"user_detail",t.smeID+" lets check system capacity!"),logger.log("DEB",t.channel.id,"user_detail",t.smeID+" Live Incoming Calls of Server("+t.all_Sme_liveCalls_incoming+") & Server Incoming Capacity("+cfg.system.incoming_channels_capacity+")"),l=Math.round(cfg.system.incoming_channels_capacity/t.all_Sme_liveCalls_incoming*100),logger.log("INFO",t.channel.id,"user_detail",t.smeID+" Overall Incoming Utilization of Server ("+l+")"),l>cfg.system.max_resource_utilization?(logger.log("INFO",t.channel.id,"user_detail",t.smeID+" Server Incoming Utilization OK ("+l+") Server Capacity Utilization("+cfg.system.max_resource_utilization+"), so allowing this call...."),logger.log("IMP",t.channel.id,"user_detail","CALL ALLOWED!")):(logger.log("INFO",t.channel.id,"user_detail",t.smeID+" Server Incoming Utilization NOT OK ("+l+") Server Capacity Utilization("+cfg.system.max_resource_utilization+"), so DONT allowing this call...."),logger.log("IMP",t.channel.id,"user_detail","CALL NOT ALLOWED!"))):logger.log("IMP",t.channel.id,"user_detail","CALL ALLOWED!"),logger.log("IMP",t.channel.id,"user_detail","[BALANCE CHECK] - of sme("+t.smeID+")"),0==t.smeBillingStatus?(logger.log("IMP",t.channel.id,"user_detail","[BILLING_STOP] - no balance of sme("+t.smeID+")"),logger.log("DEB",t.channel.id,"user_detail","sme("+t.smeID+") of customer number ("+t.calling_number+") is calling sopeed because of no billing."),t.endCallCdrProcessedFlag=!0,t.calldisconnectedBy="low balance",g()):0!=n.data.blackListIvr.length?(logger.log("IMP",t.channel.id,"user_detail","customer number ("+t.calling_number+") is blacklisted"),t.callBlackListCustomerFlag="7",t.calldisconnectedBy="blacklisted",logger.log("DEB",t.channel.id,"user_detail","hangupBlackListCall.."),g()):(e=!1,1==(e=t.all_call_mode?t.all_call_mode.includes("CRM_APP"):e)?(logger.log("DEB",t.channel.id,"main","CRM_APP Call Mode: "+e),t.callType="2",logger.log("IMP",t.channel.id,"user_detail","[ {st_CRM_APP_CALL} ]"),logger.log("DEB",t.channel.id,"user_detail","Incoming call from non agent setup to customer direct...CRM_APP"),logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => AGENT_C2C_3RDPARTY]"),t.state_machine.change_state(Event.AGENT_C2C_3RDPARTY)):t.agentAssignedVN&&t.agentAssignedVNAgentID&&"virtual"==t.agentAssignedVNAgentType&&""!=t.agentEmail&&"0"!=t.agentEmail?(logger.log("DEB",t.channel.id,"user_detail","this virtual no("+t.channel.dialplan.exten+") is assigned to AgentID("+t.agentAssignedVNAgentID+") and also call from Android App ("+t.agentEmail+")"),t.AgentStartCallTime=dateTime.getAgentDateTime(),t.callType="6",logger.log("IMP",t.channel.id,"user_detail","[ {st_KOMM_APP_CALL} ]"),t.liveEventCallType="Outgoing",t.callModeNew="4",logger.log("DEB",t.channel.id,"user_detail","Agent configured for App, AgentEmail("+t.agentEmail+")"),t.callagentincomingstate="AGENT_WELCOME",logger.log("DEB",t.channel.id,"user_detail","Its Agent Incoming call (App-Call)"),logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => AGENT_C2C]"),t.state_machine.change_state(Event.AGENT_C2C)):t.agentAssignedVN&&t.agentAssignedVNAgentID&&"virtual"==t.agentAssignedVNAgentType?(logger.log("DEB",t.channel.id,"user_detail","Bypass IVR flow.... direct agent call"),logger.log("DEB",t.channel.id,"user_detail","this virtual no("+t.channel.dialplan.exten+") is assigned to AgentID("+t.agentAssignedVNAgentID+")"),logger.log("DEB",t.channel.id,"user_detail","need to connect directly with AgentID("+t.agentAssignedVNAgentID+")"),agentProcessor.setEndCallCdr(t,"0"),logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => IVR_RECEIVED]"),t.state_machine.change_state(Event.IVR_RECEIVED)):0==n.data.agentList.length?(t.callType="1",!0===(e=t.gliveEvents.includes("evt_invite"))?(t.activeEvents="evt_invite",logger.log("DEB",t.channel.id,"user_detail","SME("+t.smeID+") subscribed for evt_invite"),logger.log("DEB",t.channel.id,"user_detail","initiate live event................................................."),agentProcessor.funcNotifyCrmIncomingCalls(t,"evt_invite")):logger.log("DEB",t.channel.id,"user_detail","SME("+t.smeID+") not subscribed for evt_invite from("+t.gliveEvents+")"),t.callType="8",logger.log("DEB",t.channel.id,"user_detail","Init Call CDR and Unique Number Detail Set on NEW CALL."),agentProcessor.setEndCallCdr(t,"0"),1!=t.mainLegDinit&&"0"==t.parallelRingingChannels?(logger.log("DEB",t.channel.id,"user_detail","mainLegDinit false, set NEW livecall"),agentProcessor.addLiveCall(t)):logger.log("DEB",t.channel.id,"user_detail","mainLegDinit true, dont set livecall"),logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => SME_RECEIVED]"),t.state_machine.change_state(Event.SME_RECEIVED)):(t.AgentStartCallTime=dateTime.getAgentDateTime(),"0"==t.agentEmail?(logger.log("IMP",t.channel.id,"user_detail","[ {st_KOMM_IVR_AGENT_CALL} ]"),logger.log("DEB",t.channel.id,"user_detail","Agent not configured for App, AgentEmail("+t.agentEmail+")"),t.callagentincomingstate="AGENT_WELCOME",t.callType="9",logger.log("DEB",t.channel.id,"user_detail","Its Agent Incoming call (IVR-Call)"),t.callModeNew="4",logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => AGENT_INCOMING]"),t.state_machine.change_state(Event.AGENT_INCOMING)):(t.callType="6",logger.log("IMP",t.channel.id,"user_detail","[ {st_KOMM_APP_CALL} ]"),t.liveEventCallType="Outgoing",t.callModeNew="4",logger.log("DEB",t.channel.id,"user_detail","Agent configured for App, AgentEmail("+t.agentEmail+")"),t.callagentincomingstate="AGENT_WELCOME",logger.log("DEB",t.channel.id,"user_detail","Its Agent Incoming call (App-Call)"),logger.log("IMP",t.channel.id,"user_detail","FSM State Changed [TO => AGENT_C2C]"),t.state_machine.change_state(Event.AGENT_C2C))))):(logger.log("ERR",t.channel.id,"user_detail","no record found in db"+n.status),logger.log("DEB",t.channel.id,"user_detail","cleanup.."),i(),logger.log("DEB",t.channel.id,"user_detail","hangup invalid SME.."),g()))})}}module.exports=GetSmeDetail;